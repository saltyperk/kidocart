<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - KidoCart</title>
  <link rel="icon" type="image/png" href="/logo.png">
  <link rel="stylesheet" href="css/checkout.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <!-- HEADER -->
  <header class="header" id="header">
    <div class="header-container">
      <a href="index.html" class="logo">
        <i class="fas fa-baby"></i>
        Kido<span>Cart</span>
      </a>
      
      <div class="checkout-steps">
        <div class="step active">
          <i class="fas fa-shopping-cart"></i>
          <span>Cart</span>
        </div>
        <div class="step-divider"></div>
        <div class="step active">
          <i class="fas fa-info-circle"></i>
          <span>Information</span>
        </div>
        <div class="step-divider"></div>
        <div class="step">
          <i class="fas fa-credit-card"></i>
          <span>Payment</span>
        </div>
      </div>
      
      <div class="header-secure">
        <i class="fas fa-lock"></i>
        <span>Secure Checkout</span>
      </div>
    </div>
  </header>

  <!-- CHECKOUT PAGE -->
  <div class="checkout-page">
    <div class="checkout-container">
      <!-- Main Content -->
      <div class="checkout-main">
        <!-- Contact Information -->
        <section class="checkout-section">
          <div class="section-header">
            <h2>Contact Information</h2>
          </div>
          
          <div class="form-group">
            <label for="email">Email Address *</label>
            <input type="email" id="email" class="form-input" placeholder="your@email.com" required>
          </div>

          <div class="form-group">
            <label for="phone">Phone Number *</label>
            <input type="tel" id="phone" class="form-input" placeholder="+91 98765 43210" required>
          </div>
        </section>

        <!-- Saved Addresses -->
        <section class="checkout-section" id="saved-addresses-section" style="display: none;">
          <div class="section-header">
            <h2>Select Delivery Address</h2>
            <button class="btn btn-secondary btn-sm" onclick="showAddNewAddress()">
              <i class="fas fa-plus"></i> Add New Address
            </button>
          </div>

          <div id="saved-addresses-list" class="saved-addresses-grid">
            <!-- Saved addresses will load here -->
          </div>
        </section>

        <!-- New Address Form -->
        <section class="checkout-section" id="new-address-section">
          <div class="section-header">
            <h2>Shipping Address</h2>
            <button class="btn btn-secondary btn-sm" id="back-to-saved-btn" onclick="backToSavedAddresses()" style="display: none;">
              <i class="fas fa-arrow-left"></i> Back to Saved Addresses
            </button>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="firstName">First Name *</label>
              <input type="text" id="firstName" class="form-input" required>
            </div>
            <div class="form-group">
              <label for="lastName">Last Name *</label>
              <input type="text" id="lastName" class="form-input" required>
            </div>
          </div>

          <div class="form-group">
            <label for="address">Address *</label>
            <input type="text" id="address" class="form-input" placeholder="Street address" required>
          </div>

          <div class="form-group">
            <label for="apartment">Apartment, suite, etc. (optional)</label>
            <input type="text" id="apartment" class="form-input" placeholder="Apartment, suite, unit, etc.">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="city">City *</label>
              <input type="text" id="city" class="form-input" required>
            </div>
            <div class="form-group">
              <label for="state">State *</label>
              <select id="state" class="form-input" required>
                <option value="">Select State</option>
                <option value="AN">Andaman and Nicobar Islands</option>
                <option value="AP">Andhra Pradesh</option>
                <option value="AR">Arunachal Pradesh</option>
                <option value="AS">Assam</option>
                <option value="BR">Bihar</option>
                <option value="CH">Chandigarh</option>
                <option value="CT">Chhattisgarh</option>
                <option value="DN">Dadra and Nagar Haveli</option>
                <option value="DD">Daman and Diu</option>
                <option value="DL">Delhi</option>
                <option value="GA">Goa</option>
                <option value="GJ">Gujarat</option>
                <option value="HR">Haryana</option>
                <option value="HP">Himachal Pradesh</option>
                <option value="JK">Jammu and Kashmir</option>
                <option value="JH">Jharkhand</option>
                <option value="KA">Karnataka</option>
                <option value="KL">Kerala</option>
                <option value="LA">Ladakh</option>
                <option value="LD">Lakshadweep</option>
                <option value="MP">Madhya Pradesh</option>
                <option value="MH">Maharashtra</option>
                <option value="MN">Manipur</option>
                <option value="ML">Meghalaya</option>
                <option value="MZ">Mizoram</option>
                <option value="NL">Nagaland</option>
                <option value="OR">Odisha</option>
                <option value="PY">Puducherry</option>
                <option value="PB">Punjab</option>
                <option value="RJ">Rajasthan</option>
                <option value="SK">Sikkim</option>
                <option value="TN">Tamil Nadu</option>
                <option value="TG">Telangana</option>
                <option value="TR">Tripura</option>
                <option value="UP">Uttar Pradesh</option>
                <option value="UT">Uttarakhand</option>
                <option value="WB">West Bengal</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="pincode">PIN Code *</label>
            <input type="text" id="pincode" class="form-input" placeholder="400001" maxlength="6" required>
          </div>

          <label class="checkbox-label">
            <input type="checkbox" id="saveAddress" checked>
            <span>Save this address for future orders</span>
          </label>
        </section>

        <!-- Payment Method -->
        <section class="checkout-section">
          <div class="section-header">
            <h2>Payment Method</h2>
            <div class="phonepe-badge">
              <span>Powered by</span>
              <strong>PhonePe</strong>
            </div>
          </div>

          <div class="payment-info">
            <i class="fas fa-shield-alt"></i>
            <div>
              <strong>Secure Payment via PhonePe</strong>
              <p>All payments are processed through PhonePe's secure gateway</p>
            </div>
          </div>

          <div class="payment-methods-grid">
            <div class="payment-method-card">
              <i class="fas fa-credit-card"></i>
              <span>Cards</span>
            </div>
            <div class="payment-method-card">
              <i class="fas fa-mobile-alt"></i>
              <span>UPI</span>
            </div>
            <div class="payment-method-card">
              <i class="fas fa-university"></i>
              <span>Net Banking</span>
            </div>
            <div class="payment-method-card">
              <i class="fas fa-wallet"></i>
              <span>Wallets</span>
            </div>
          </div>

          <div class="payment-note">
            <i class="fas fa-info-circle"></i>
            <span>You will be redirected to PhonePe payment page after placing order</span>
          </div>
        </section>

        <!-- Action Buttons -->
        <div class="checkout-actions">
          <a href="cart.html" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i>
            Return to Cart
          </a>
          <button class="btn btn-primary" onclick="placeOrder()" id="place-order-btn">
            <i class="fas fa-lock"></i>
            Proceed to Payment
          </button>
        </div>
      </div>

      <!-- Order Summary Sidebar -->
      <div class="order-summary">
        <h3>Order Summary</h3>

        <div class="summary-items" id="summary-items">
          <div class="loading-skeleton" style="height: 100px;"></div>
          <div class="loading-skeleton" style="height: 100px;"></div>
        </div>

        <div class="coupon-section">
          <input type="text" id="coupon-code" class="form-input" placeholder="Discount code">
          <button class="btn btn-secondary btn-sm" onclick="applyCoupon()">Apply</button>
        </div>

        <div class="summary-breakdown">
          <div class="summary-row">
            <span>Subtotal</span>
            <span id="summary-subtotal">₹0</span>
          </div>
          <div class="summary-row">
            <span>Shipping</span>
            <span id="summary-shipping">FREE</span>
          </div>
          <div class="summary-row">
            <span>Discount</span>
            <span id="summary-discount" class="discount-text">-₹0</span>
          </div>
          <div class="summary-divider"></div>
          <div class="summary-row total">
            <span>Total</span>
            <span id="summary-total">₹0</span>
          </div>
        </div>

        <div class="trust-badges">
          <div class="trust-item">
            <i class="fas fa-shield-alt"></i>
            <span>Secure Payment</span>
          </div>
          <div class="trust-item">
            <i class="fas fa-lock"></i>
            <span>SSL Encrypted</span>
          </div>
          <div class="trust-item">
            <i class="fas fa-undo"></i>
            <span>Easy Returns</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <!-- PhonePe Script -->
  <script src="https://mercury-t2.phonepe.com/web-static/sdk/v1/phonepe.js"></script>

  <script src="js/app.js"></script>
  <script>
    // Global variables
    let cartData = null;
    let savedAddresses = [];
    let selectedAddress = null;
    let currentUser = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', async function() {
      await checkLoginAndInit();
    });

    // Check login and initialize
    async function checkLoginAndInit() {
      const token = localStorage.getItem('kidocart_token');
      
      if (!token) {
        showToast('Please login to continue', 'warning');
        setTimeout(() => {
          window.location.href = 'login.html?redirect=checkout.html';
        }, 1500);
        return;
      }

      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        currentUser = payload;
        
        await loadUserData();
        await loadCart();
        await loadSavedAddresses();
      } catch (error) {
        console.error('Auth error:', error);
        localStorage.removeItem('kidocart_token');
        window.location.href = 'login.html?redirect=checkout.html';
      }
    }

    // Load user data
    async function loadUserData() {
      document.getElementById('email').value = currentUser.email || '';
      
      const nameParts = (currentUser.name || '').split(' ');
      document.getElementById('firstName').value = nameParts[0] || '';
      document.getElementById('lastName').value = nameParts.slice(1).join(' ') || '';
      
      document.getElementById('phone').value = currentUser.phone || '';
    }

    // Load cart
    async function loadCart() {
      const token = localStorage.getItem('kidocart_token');

      try {
        const response = await fetch('/api/cart', {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (response.ok) {
          cartData = await response.json();

          if (!cartData.items || cartData.items.length === 0) {
            window.location.href = 'cart.html';
            return;
          }

          displayOrderSummary();
        } else {
          throw new Error('Failed to load cart');
        }
      } catch (error) {
        console.error('Error loading cart:', error);
        showToast('Failed to load cart', 'error');
      }
    }

    // Load saved addresses
    async function loadSavedAddresses() {
      const token = localStorage.getItem('kidocart_token');

      try {
        const response = await fetch('/api/addresses', {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (response.ok) {
          savedAddresses = await response.json();

          if (savedAddresses && savedAddresses.length > 0) {
            displaySavedAddresses();
            document.getElementById('saved-addresses-section').style.display = 'block';
            document.getElementById('new-address-section').style.display = 'none';
            document.getElementById('back-to-saved-btn').style.display = 'inline-flex';
          } else {
            document.getElementById('saved-addresses-section').style.display = 'none';
            document.getElementById('new-address-section').style.display = 'block';
          }
        }
      } catch (error) {
        console.error('Error loading addresses:', error);
      }
    }

    // Display saved addresses
    function displaySavedAddresses() {
      const container = document.getElementById('saved-addresses-list');
      
      container.innerHTML = savedAddresses.map((addr, index) => `
        <div class="address-card ${addr.isDefault ? 'default' : ''}" onclick="selectAddress(${index})">
          ${addr.isDefault ? '<span class="default-badge">Default</span>' : ''}
          <div class="address-header">
            <h4>${addr.firstName} ${addr.lastName}</h4>
            <input type="radio" name="address" value="${index}" ${addr.isDefault ? 'checked' : ''}>
          </div>
          <p class="address-text">
            ${addr.address}${addr.apartment ? ', ' + addr.apartment : ''}<br>
            ${addr.city}, ${addr.state} - ${addr.pincode}
          </p>
          <p class="address-phone">
            <i class="fas fa-phone"></i> ${document.getElementById('phone').value}
          </p>
        </div>
      `).join('');

      // Auto-select default address
      const defaultAddr = savedAddresses.find(addr => addr.isDefault);
      if (defaultAddr) {
        selectedAddress = defaultAddr;
      } else {
        selectedAddress = savedAddresses[0];
      }
    }

    // Select address
    function selectAddress(index) {
      selectedAddress = savedAddresses[index];
      document.querySelectorAll('.address-card').forEach((card, i) => {
        card.classList.toggle('selected', i === index);
      });
      document.querySelector(`input[name="address"][value="${index}"]`).checked = true;
    }

    // Show add new address form
    function showAddNewAddress() {
      document.getElementById('saved-addresses-section').style.display = 'none';
      document.getElementById('new-address-section').style.display = 'block';
      selectedAddress = null;
      
      // Clear form
      document.getElementById('address').value = '';
      document.getElementById('apartment').value = '';
      document.getElementById('city').value = '';
      document.getElementById('state').value = '';
      document.getElementById('pincode').value = '';
    }

    // Back to saved addresses
    function backToSavedAddresses() {
      if (savedAddresses.length > 0) {
        document.getElementById('saved-addresses-section').style.display = 'block';
        document.getElementById('new-address-section').style.display = 'none';
        
        // Reselect default or first address
        const defaultAddr = savedAddresses.find(addr => addr.isDefault);
        selectedAddress = defaultAddr || savedAddresses[0];
      }
    }

    // Display order summary
    function displayOrderSummary() {
      const itemsContainer = document.getElementById('summary-items');
      
      itemsContainer.innerHTML = cartData.items.map(item => {
        const product = item.productId;
        const imageUrl = product.images?.[0] || 'https://via.placeholder.com/60x60?text=No+Image';

        return `
          <div class="summary-item">
            <div class="item-image">
              <img src="${imageUrl}" alt="${product.name}">
              <span class="item-qty">${item.quantity}</span>
            </div>
            <div class="item-info">
              <h4>${product.name}</h4>
              ${item.size || item.color ? `
                <div class="item-variants">
                  ${item.size ? `<span>${item.size}</span>` : ''}
                  ${item.color ? `<span>${item.color}</span>` : ''}
                </div>
              ` : ''}
            </div>
            <div class="item-price">₹${(item.price * item.quantity).toLocaleString('en-IN')}</div>
          </div>
        `;
      }).join('');

      calculateSummary();
    }

    // Calculate summary
    function calculateSummary() {
      let subtotal = 0;
      let discount = 0;

      cartData.items.forEach(item => {
        const product = item.productId;
        subtotal += item.price * item.quantity;

        if (product.originalPrice && product.originalPrice > item.price) {
          discount += (product.originalPrice - item.price) * item.quantity;
        }
      });

      const shipping = subtotal >= 500 ? 0 : 50;
      const total = subtotal + shipping - discount;

      document.getElementById('summary-subtotal').textContent = `₹${subtotal.toLocaleString('en-IN')}`;
      document.getElementById('summary-shipping').textContent = shipping === 0 ? 'FREE' : `₹${shipping}`;
      document.getElementById('summary-discount').textContent = discount > 0 ? `-₹${discount.toLocaleString('en-IN')}` : '₹0';
      document.getElementById('summary-total').textContent = `₹${total.toLocaleString('en-IN')}`;
    }

    // Apply coupon
    function applyCoupon() {
      const code = document.getElementById('coupon-code').value.trim();
      
      if (!code) {
        showToast('Please enter a coupon code', 'warning');
        return;
      }

      showToast('Coupon feature coming soon!', 'info');
    }

    // Validate form
    function validateCheckout() {
      const email = document.getElementById('email').value;
      const phone = document.getElementById('phone').value;

      if (!email || !phone) {
        showToast('Please fill contact information', 'warning');
        return false;
      }

      // Email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showToast('Please enter a valid email address', 'warning');
        return false;
      }

      // Check if address is selected or new address is filled
      if (!selectedAddress) {
        const address = document.getElementById('address').value;
        const city = document.getElementById('city').value;
        const state = document.getElementById('state').value;
        const pincode = document.getElementById('pincode').value;

        if (!address || !city || !state || !pincode) {
          showToast('Please fill all address fields', 'warning');
          return false;
        }

        // PIN code validation
        const pincodeRegex = /^[0-9]{6}$/;
        if (!pincodeRegex.test(pincode)) {
          showToast('Please enter a valid 6-digit PIN code', 'warning');
          return false;
        }
      }

      return true;
    }

    // Place order and initiate PhonePe payment
    async function placeOrder() {
      if (!validateCheckout()) {
        return;
      }

      const token = localStorage.getItem('kidocart_token');
      const btn = document.getElementById('place-order-btn');
      
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

      try {
        // Prepare address
        let shippingAddress;
        
        if (selectedAddress) {
          shippingAddress = selectedAddress;
        } else {
          shippingAddress = {
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            address: document.getElementById('address').value,
            apartment: document.getElementById('apartment').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            pincode: document.getElementById('pincode').value
          };

          // Save address if checkbox is checked
          if (document.getElementById('saveAddress').checked) {
            await saveAddress(shippingAddress);
          }
        }

        // Calculate total
        let subtotal = 0;
        cartData.items.forEach(item => {
          subtotal += item.price * item.quantity;
        });
        const shipping = subtotal >= 500 ? 0 : 50;
        const total = subtotal + shipping;

        // Create order
        const orderData = {
          email: document.getElementById('email').value,
          phone: document.getElementById('phone').value,
          shippingAddress: shippingAddress,
          paymentMethod: 'phonepe',
          items: cartData.items.map(item => ({
            productId: item.productId._id || item.productId.id,
            quantity: item.quantity,
            price: item.price,
            size: item.size,
            color: item.color
          })),
          total: total
        };

        const response = await fetch('/api/orders', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(orderData)
        });

        if (response.ok) {
          const order = await response.json();
          
          // Initiate PhonePe payment
          await initiatePhonePePayment(order);
        } else {
          const error = await response.json();
          throw new Error(error.error || 'Failed to create order');
        }
      } catch (error) {
        console.error('Error placing order:', error);
        showToast(error.message || 'Failed to place order', 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-lock"></i> Proceed to Payment';
      }
    }

    // Initiate PhonePe payment
    async function initiatePhonePePayment(order) {
      const token = localStorage.getItem('kidocart_token');

      try {
        const response = await fetch('/api/payment/phonepe/initiate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({
            orderId: order._id,
            amount: order.total,
            customerPhone: document.getElementById('phone').value,
            customerEmail: document.getElementById('email').value
          })
        });

        if (response.ok) {
          const paymentData = await response.json();
          
          // Redirect to PhonePe payment page
          window.location.href = paymentData.redirectUrl;
        } else {
          throw new Error('Failed to initiate payment');
        }
      } catch (error) {
        console.error('Payment error:', error);
        showToast('Failed to initiate payment', 'error');
        document.getElementById('place-order-btn').disabled = false;
        document.getElementById('place-order-btn').innerHTML = '<i class="fas fa-lock"></i> Proceed to Payment';
      }
    }

    // Save address
    async function saveAddress(addressData) {
      const token = localStorage.getItem('kidocart_token');

      try {
        await fetch('/api/addresses', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(addressData)
        });
      } catch (error) {
        console.error('Error saving address:', error);
      }
    }

    // Toast
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast show ${type}`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // PIN code validation
    document.getElementById('pincode')?.addEventListener('input', function(e) {
      e.target.value = e.target.value.replace(/\D/g, '').slice(0, 6);
    });
  </script>
</body>
</html>
