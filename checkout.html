<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - KidoCart</title>
  <link rel="icon" type="image/png" href="/logo.png">
  <link rel="stylesheet" href="css/checkout.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <!-- HEADER (Same as index.html) -->
  <header class="header" id="header">
    <div class="header-container">
      <a href="index.html" class="logo">
        <i class="fas fa-baby"></i>
        Kido<span>Cart</span>
      </a>
      
      <div class="checkout-steps">
        <div class="step active">
          <i class="fas fa-shopping-cart"></i>
          <span>Cart</span>
        </div>
        <div class="step-divider"></div>
        <div class="step active">
          <i class="fas fa-info-circle"></i>
          <span>Information</span>
        </div>
        <div class="step-divider"></div>
        <div class="step">
          <i class="fas fa-credit-card"></i>
          <span>Payment</span>
        </div>
      </div>
      
      <div class="header-secure">
        <i class="fas fa-lock"></i>
        <span>Secure Checkout</span>
      </div>
    </div>
  </header>

  <!-- CHECKOUT PAGE -->
  <div class="checkout-page">
    <div class="checkout-container">
      <!-- Main Content -->
      <div class="checkout-main">
        <!-- Contact Information -->
        <section class="checkout-section">
          <div class="section-header">
            <h2>Contact Information</h2>
            <p>Already have an account? <a href="login.html">Login</a></p>
          </div>
          
          <div class="form-group">
            <label for="email">Email Address *</label>
            <input type="email" id="email" class="form-input" placeholder="your@email.com" required>
          </div>

          <div class="form-group">
            <label for="phone">Phone Number *</label>
            <input type="tel" id="phone" class="form-input" placeholder="+91 98765 43210" required>
          </div>

          <label class="checkbox-label">
            <input type="checkbox" id="newsletter">
            <span>Email me with news and offers</span>
          </label>
        </section>

        <!-- Shipping Address -->
        <section class="checkout-section">
          <div class="section-header">
            <h2>Shipping Address</h2>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="firstName">First Name *</label>
              <input type="text" id="firstName" class="form-input" required>
            </div>
            <div class="form-group">
              <label for="lastName">Last Name *</label>
              <input type="text" id="lastName" class="form-input" required>
            </div>
          </div>

          <div class="form-group">
            <label for="address">Address *</label>
            <input type="text" id="address" class="form-input" placeholder="Street address" required>
          </div>

          <div class="form-group">
            <label for="apartment">Apartment, suite, etc. (optional)</label>
            <input type="text" id="apartment" class="form-input" placeholder="Apartment, suite, unit, etc.">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="city">City *</label>
              <input type="text" id="city" class="form-input" required>
            </div>
            <div class="form-group">
              <label for="state">State *</label>
              <select id="state" class="form-input" required>
                <option value="">Select State</option>
                <option value="AN">Andaman and Nicobar Islands</option>
                <option value="AP">Andhra Pradesh</option>
                <option value="AR">Arunachal Pradesh</option>
                <option value="AS">Assam</option>
                <option value="BR">Bihar</option>
                <option value="CH">Chandigarh</option>
                <option value="CT">Chhattisgarh</option>
                <option value="DN">Dadra and Nagar Haveli</option>
                <option value="DD">Daman and Diu</option>
                <option value="DL">Delhi</option>
                <option value="GA">Goa</option>
                <option value="GJ">Gujarat</option>
                <option value="HR">Haryana</option>
                <option value="HP">Himachal Pradesh</option>
                <option value="JK">Jammu and Kashmir</option>
                <option value="JH">Jharkhand</option>
                <option value="KA">Karnataka</option>
                <option value="KL">Kerala</option>
                <option value="LA">Ladakh</option>
                <option value="LD">Lakshadweep</option>
                <option value="MP">Madhya Pradesh</option>
                <option value="MH">Maharashtra</option>
                <option value="MN">Manipur</option>
                <option value="ML">Meghalaya</option>
                <option value="MZ">Mizoram</option>
                <option value="NL">Nagaland</option>
                <option value="OR">Odisha</option>
                <option value="PY">Puducherry</option>
                <option value="PB">Punjab</option>
                <option value="RJ">Rajasthan</option>
                <option value="SK">Sikkim</option>
                <option value="TN">Tamil Nadu</option>
                <option value="TG">Telangana</option>
                <option value="TR">Tripura</option>
                <option value="UP">Uttar Pradesh</option>
                <option value="UT">Uttarakhand</option>
                <option value="WB">West Bengal</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="pincode">PIN Code *</label>
            <input type="text" id="pincode" class="form-input" placeholder="400001" maxlength="6" required>
          </div>

          <label class="checkbox-label">
            <input type="checkbox" id="saveAddress">
            <span>Save this address for next time</span>
          </label>
        </section>

        <!-- Shipping Method -->
        <section class="checkout-section">
          <div class="section-header">
            <h2>Shipping Method</h2>
          </div>

          <div class="shipping-options">
            <label class="shipping-option">
              <input type="radio" name="shipping" value="standard" checked>
              <div class="option-content">
                <div class="option-info">
                  <strong>Standard Shipping</strong>
                  <span>5-7 business days</span>
                </div>
                <div class="option-price">FREE</div>
              </div>
            </label>

            <label class="shipping-option">
              <input type="radio" name="shipping" value="express">
              <div class="option-content">
                <div class="option-info">
                  <strong>Express Shipping</strong>
                  <span>2-3 business days</span>
                </div>
                <div class="option-price">₹150</div>
              </div>
            </label>

            <label class="shipping-option">
              <input type="radio" name="shipping" value="overnight">
              <div class="option-content">
                <div class="option-info">
                  <strong>Overnight Shipping</strong>
                  <span>Next business day</span>
                </div>
                <div class="option-price">₹300</div>
              </div>
            </label>
          </div>
        </section>

        <!-- Payment Method -->
        <section class="checkout-section">
          <div class="section-header">
            <h2>Payment Method</h2>
          </div>

          <div class="payment-options">
            <label class="payment-option">
              <input type="radio" name="payment" value="cod" checked>
              <div class="option-content">
                <i class="fas fa-money-bill-wave"></i>
                <div class="option-info">
                  <strong>Cash on Delivery</strong>
                  <span>Pay when you receive</span>
                </div>
              </div>
            </label>

            <label class="payment-option">
              <input type="radio" name="payment" value="card">
              <div class="option-content">
                <i class="fas fa-credit-card"></i>
                <div class="option-info">
                  <strong>Credit/Debit Card</strong>
                  <span>Visa, Mastercard, RuPay</span>
                </div>
              </div>
            </label>

            <label class="payment-option">
              <input type="radio" name="payment" value="upi">
              <div class="option-content">
                <i class="fas fa-mobile-alt"></i>
                <div class="option-info">
                  <strong>UPI Payment</strong>
                  <span>Google Pay, PhonePe, Paytm</span>
                </div>
              </div>
            </label>

            <label class="payment-option">
              <input type="radio" name="payment" value="netbanking">
              <div class="option-content">
                <i class="fas fa-university"></i>
                <div class="option-info">
                  <strong>Net Banking</strong>
                  <span>All major banks</span>
                </div>
              </div>
            </label>
          </div>

          <!-- Card Details (shown when card is selected) -->
          <div id="card-details" class="card-details" style="display: none;">
            <div class="form-group">
              <label for="cardNumber">Card Number</label>
              <input type="text" id="cardNumber" class="form-input" placeholder="1234 5678 9012 3456" maxlength="19">
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="cardExpiry">Expiry Date</label>
                <input type="text" id="cardExpiry" class="form-input" placeholder="MM/YY" maxlength="5">
              </div>
              <div class="form-group">
                <label for="cardCVV">CVV</label>
                <input type="text" id="cardCVV" class="form-input" placeholder="123" maxlength="3">
              </div>
            </div>

            <div class="form-group">
              <label for="cardName">Name on Card</label>
              <input type="text" id="cardName" class="form-input" placeholder="John Doe">
            </div>
          </div>
        </section>

        <!-- Action Buttons -->
        <div class="checkout-actions">
          <a href="cart.html" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i>
            Return to Cart
          </a>
          <button class="btn btn-primary" onclick="placeOrder()" id="place-order-btn">
            <i class="fas fa-check"></i>
            Place Order
          </button>
        </div>
      </div>

      <!-- Order Summary Sidebar -->
      <div class="order-summary">
        <h3>Order Summary</h3>

        <!-- Cart Items -->
        <div class="summary-items" id="summary-items">
          <!-- Items will be loaded here -->
          <div class="loading-skeleton" style="height: 100px;"></div>
          <div class="loading-skeleton" style="height: 100px;"></div>
        </div>

        <!-- Coupon Code -->
        <div class="coupon-section">
          <input type="text" id="coupon-code" class="form-input" placeholder="Discount code">
          <button class="btn btn-secondary btn-sm" onclick="applyCoupon()">Apply</button>
        </div>

        <!-- Summary Breakdown -->
        <div class="summary-breakdown">
          <div class="summary-row">
            <span>Subtotal</span>
            <span id="summary-subtotal">₹0</span>
          </div>
          <div class="summary-row">
            <span>Shipping</span>
            <span id="summary-shipping">FREE</span>
          </div>
          <div class="summary-row">
            <span>Discount</span>
            <span id="summary-discount" class="discount-text">-₹0</span>
          </div>
          <div class="summary-divider"></div>
          <div class="summary-row total">
            <span>Total</span>
            <span id="summary-total">₹0</span>
          </div>
        </div>

        <!-- Trust Badges -->
        <div class="trust-badges">
          <div class="trust-item">
            <i class="fas fa-shield-alt"></i>
            <span>Secure Payment</span>
          </div>
          <div class="trust-item">
            <i class="fas fa-lock"></i>
            <span>SSL Encrypted</span>
          </div>
          <div class="trust-item">
            <i class="fas fa-undo"></i>
            <span>Easy Returns</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <!-- Success Modal -->
  <div class="modal" id="success-modal">
    <div class="modal-content success">
      <i class="fas fa-check-circle"></i>
      <h2>Order Placed Successfully!</h2>
      <p>Your order has been received and is being processed.</p>
      <p class="order-number">Order #<span id="order-number">000000</span></p>
      <div class="modal-actions">
        <a href="orders.html" class="btn btn-primary">View Orders</a>
        <a href="index.html" class="btn btn-secondary">Continue Shopping</a>
      </div>
    </div>
  </div>

  <script src="js/app.js"></script>
  <script>
    // Global variables
    let cartData = null;
    let shippingCost = 0;

    // Initialize
    document.addEventListener('DOMContentLoaded', async function() {
      await loadCart();
      setupPaymentMethodSwitch();
      setupShippingMethodSwitch();
      loadUserData();
    });

    // Load user data if logged in
    function loadUserData() {
      const token = localStorage.getItem('kidocart_token');
      
      if (token) {
        try {
          const payload = JSON.parse(atob(token.split('.')[1]));
          document.getElementById('email').value = payload.email || '';
          document.getElementById('firstName').value = payload.name?.split(' ')[0] || '';
          document.getElementById('lastName').value = payload.name?.split(' ').slice(1).join(' ') || '';
          document.getElementById('phone').value = payload.phone || '';
        } catch (error) {
          console.error('Error loading user data:', error);
        }
      }
    }

    // Load cart
    async function loadCart() {
      const token = localStorage.getItem('kidocart_token');
      
      if (!token) {
        window.location.href = 'login.html';
        return;
      }

      try {
        const response = await fetch('/api/cart', {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (response.ok) {
          cartData = await response.json();

          if (!cartData.items || cartData.items.length === 0) {
            window.location.href = 'cart.html';
            return;
          }

          displayOrderSummary();
        } else {
          throw new Error('Failed to load cart');
        }
      } catch (error) {
        console.error('Error loading cart:', error);
        showToast('Failed to load cart', 'error');
      }
    }

    // Display order summary
    function displayOrderSummary() {
      const itemsContainer = document.getElementById('summary-items');
      
      itemsContainer.innerHTML = cartData.items.map(item => {
        const product = item.productId;
        const imageUrl = product.images?.[0] || 'https://via.placeholder.com/60x60?text=No+Image';

        return `
          <div class="summary-item">
            <div class="item-image">
              <img src="${imageUrl}" alt="${product.name}">
              <span class="item-qty">${item.quantity}</span>
            </div>
            <div class="item-info">
              <h4>${product.name}</h4>
              ${item.size || item.color ? `
                <div class="item-variants">
                  ${item.size ? `<span>${item.size}</span>` : ''}
                  ${item.color ? `<span>${item.color}</span>` : ''}
                </div>
              ` : ''}
            </div>
            <div class="item-price">₹${(item.price * item.quantity).toLocaleString('en-IN')}</div>
          </div>
        `;
      }).join('');

      calculateSummary();
    }

    // Calculate summary
    function calculateSummary() {
      let subtotal = 0;
      let discount = 0;

      cartData.items.forEach(item => {
        const product = item.productId;
        subtotal += item.price * item.quantity;

        if (product.originalPrice && product.originalPrice > item.price) {
          discount += (product.originalPrice - item.price) * item.quantity;
        }
      });

      const total = subtotal + shippingCost - discount;

      document.getElementById('summary-subtotal').textContent = `₹${subtotal.toLocaleString('en-IN')}`;
      document.getElementById('summary-shipping').textContent = shippingCost === 0 ? 'FREE' : `₹${shippingCost}`;
      document.getElementById('summary-discount').textContent = discount > 0 ? `-₹${discount.toLocaleString('en-IN')}` : '₹0';
      document.getElementById('summary-total').textContent = `₹${total.toLocaleString('en-IN')}`;
    }

    // Setup payment method switch
    function setupPaymentMethodSwitch() {
      const paymentOptions = document.querySelectorAll('input[name="payment"]');
      const cardDetails = document.getElementById('card-details');

      paymentOptions.forEach(option => {
        option.addEventListener('change', function() {
          if (this.value === 'card') {
            cardDetails.style.display = 'block';
          } else {
            cardDetails.style.display = 'none';
          }
        });
      });
    }

    // Setup shipping method switch
    function setupShippingMethodSwitch() {
      const shippingOptions = document.querySelectorAll('input[name="shipping"]');

      shippingOptions.forEach(option => {
        option.addEventListener('change', function() {
          switch(this.value) {
            case 'standard':
              shippingCost = 0;
              break;
            case 'express':
              shippingCost = 150;
              break;
            case 'overnight':
              shippingCost = 300;
              break;
          }
          calculateSummary();
        });
      });
    }

    // Apply coupon
    function applyCoupon() {
      const code = document.getElementById('coupon-code').value.trim();
      
      if (!code) {
        showToast('Please enter a coupon code', 'warning');
        return;
      }

      // Placeholder - implement coupon logic
      showToast('Coupon feature coming soon!', 'info');
    }

    // Place order
    async function placeOrder() {
      // Validate form
      if (!validateForm()) {
        return;
      }

      const token = localStorage.getItem('kidocart_token');
      const btn = document.getElementById('place-order-btn');
      
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

      try {
        const orderData = {
          email: document.getElementById('email').value,
          phone: document.getElementById('phone').value,
          shippingAddress: {
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            address: document.getElementById('address').value,
            apartment: document.getElementById('apartment').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            pincode: document.getElementById('pincode').value
          },
          shippingMethod: document.querySelector('input[name="shipping"]:checked').value,
          paymentMethod: document.querySelector('input[name="payment"]:checked').value,
          items: cartData.items.map(item => ({
            productId: item.productId._id || item.productId.id,
            quantity: item.quantity,
            price: item.price,
            size: item.size,
            color: item.color
          }))
        };

        const response = await fetch('/api/orders', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(orderData)
        });

        if (response.ok) {
          const order = await response.json();
          
          // Clear cart
          await clearCart();

          // Show success modal
          document.getElementById('order-number').textContent = order._id.slice(-8).toUpperCase();
          document.getElementById('success-modal').classList.add('show');
        } else {
          const error = await response.json();
          throw new Error(error.error || 'Failed to place order');
        }
      } catch (error) {
        console.error('Error placing order:', error);
        showToast(error.message || 'Failed to place order', 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check"></i> Place Order';
      }
    }

    // Validate form
    function validateForm() {
      const email = document.getElementById('email').value;
      const phone = document.getElementById('phone').value;
      const firstName = document.getElementById('firstName').value;
      const lastName = document.getElementById('lastName').value;
      const address = document.getElementById('address').value;
      const city = document.getElementById('city').value;
      const state = document.getElementById('state').value;
      const pincode = document.getElementById('pincode').value;

      if (!email || !phone || !firstName || !lastName || !address || !city || !state || !pincode) {
        showToast('Please fill all required fields', 'warning');
        return false;
      }

      // Email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showToast('Please enter a valid email address', 'warning');
        return false;
      }

      // Phone validation
      const phoneRegex = /^[0-9]{10}$/;
      if (!phoneRegex.test(phone.replace(/\s/g, '').replace('+91', ''))) {
        showToast('Please enter a valid 10-digit phone number', 'warning');
        return false;
      }

      // PIN code validation
      const pincodeRegex = /^[0-9]{6}$/;
      if (!pincodeRegex.test(pincode)) {
        showToast('Please enter a valid 6-digit PIN code', 'warning');
        return false;
      }

      // Payment method validation
      const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
      if (paymentMethod === 'card') {
        const cardNumber = document.getElementById('cardNumber').value;
        const cardExpiry = document.getElementById('cardExpiry').value;
        const cardCVV = document.getElementById('cardCVV').value;
        const cardName = document.getElementById('cardName').value;

        if (!cardNumber || !cardExpiry || !cardCVV || !cardName) {
          showToast('Please fill all card details', 'warning');
          return false;
        }
      }

      return true;
    }

    // Clear cart
    async function clearCart() {
      const token = localStorage.getItem('kidocart_token');

      try {
        for (const item of cartData.items) {
          const productId = item.productId._id || item.productId.id;
          await fetch(`/api/cart?productId=${productId}`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
          });
        }
      } catch (error) {
        console.error('Error clearing cart:', error);
      }
    }

    // Toast
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast show ${type}`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Auto-format card number
    document.getElementById('cardNumber')?.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\s/g, '');
      let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
      e.target.value = formattedValue;
    });

    // Auto-format expiry date
    document.getElementById('cardExpiry')?.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length >= 2) {
        value = value.slice(0, 2) + '/' + value.slice(2, 4);
      }
      e.target.value = value;
    });

    // PIN code validation
    document.getElementById('pincode')?.addEventListener('input', function(e) {
      e.target.value = e.target.value.replace(/\D/g, '').slice(0, 6);
    });
  </script>
</body>
</html>
