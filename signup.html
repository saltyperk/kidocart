<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign Up - KidoCart</title>
  <link rel="icon" type="image/png" href="/logo.png">
  <link rel="stylesheet" href="css/auth.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div class="auth-page">
    <div class="auth-container">
      <!-- Left Side - Branding -->
      <div class="auth-branding">
        <a href="index.html" class="logo">
          <i class="fas fa-baby"></i>
          Kido<span>Cart</span>
        </a>
        <h1>Join KidoCart Today!</h1>
        <p>Create an account and start shopping for premium quality products for your little ones.</p>
        <div class="branding-features">
          <div class="feature">
            <i class="fas fa-gift"></i>
            <span>Welcome Offers</span>
          </div>
          <div class="feature">
            <i class="fas fa-shipping-fast"></i>
            <span>Free Shipping on First Order</span>
          </div>
          <div class="feature">
            <i class="fas fa-star"></i>
            <span>Earn Reward Points</span>
          </div>
        </div>
      </div>

      <!-- Right Side - Signup Form -->
      <div class="auth-form-container">
        <div class="auth-form">
          <h2>Create Your Account</h2>
          <p class="auth-subtitle">Sign up to get started</p>

          <!-- Google Signup -->
          <div id="google-signup-button"></div>

          <div class="divider">
            <span>OR SIGN UP WITH EMAIL</span>
          </div>

          <!-- Signup Form -->
          <form onsubmit="handleSignup(event)" id="signup-form">
            <div class="form-group">
              <label for="name">Full Name *</label>
              <div class="input-group">
                <i class="fas fa-user"></i>
                <input type="text" id="name" placeholder="Enter your full name" required minlength="2" maxlength="100">
              </div>
            </div>

            <div class="form-group">
              <label for="email">Email Address *</label>
              <div class="input-group">
                <i class="fas fa-envelope"></i>
                <input type="email" id="email" placeholder="your@email.com" required>
              </div>
            </div>

            <div class="form-group">
              <label for="phone">Phone Number (Optional)</label>
              <div class="input-group">
                <i class="fas fa-mobile-alt"></i>
                <input type="tel" id="phone" placeholder="10-digit mobile number" maxlength="10" pattern="[6-9][0-9]{9}">
              </div>
            </div>

            <div class="form-group">
              <label for="password">Password *</label>
              <div class="input-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="password" placeholder="Create a strong password" required minlength="6">
                <button type="button" class="toggle-password" onclick="togglePassword('password')">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
              <div class="password-strength" id="password-strength">
                <div class="strength-bar">
                  <div class="strength-fill" id="strength-fill"></div>
                </div>
                <span class="strength-text" id="strength-text">Password strength</span>
              </div>
            </div>

            <div class="form-group">
              <label for="confirm-password">Confirm Password *</label>
              <div class="input-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="confirm-password" placeholder="Re-enter your password" required minlength="6">
                <button type="button" class="toggle-password" onclick="togglePassword('confirm-password')">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>

            <div class="form-group checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="terms" required>
                <span>I agree to the <a href="#" target="_blank">Terms & Conditions</a> and <a href="#" target="_blank">Privacy Policy</a></span>
              </label>
            </div>

            <div class="form-group checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="newsletter">
                <span>Send me exclusive offers and updates via email</span>
              </label>
            </div>

            <button type="submit" class="btn btn-primary" id="signup-btn">
              <i class="fas fa-user-plus"></i> Create Account
            </button>
          </form>

          <!-- Login Link -->
          <div class="auth-footer">
            <p>Already have an account? <a href="login.html">Login</a></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <script>
    // Initialize Google Sign-In
    function initGoogleSignIn() {
      if (typeof google !== 'undefined') {
        google.accounts.id.initialize({
          client_id: '163244508840-kcersqu6gr3mg2kas71enpr07o3s4vbv.apps.googleusercontent.com', // Replace with your Google Client ID
          callback: handleGoogleSignup,
          auto_select: false
        });

        google.accounts.id.renderButton(
          document.getElementById('google-signup-button'),
          { 
            theme: 'outline', 
            size: 'large',
            width: '100%',
            text: 'signup_with',
            shape: 'rectangular'
          }
        );
      }
    }

    window.onload = function() {
      initGoogleSignIn();
    };

    // Toggle password visibility
    function togglePassword(inputId) {
      const input = document.getElementById(inputId);
      const icon = event.currentTarget.querySelector('i');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    }

    // Password strength checker
    document.getElementById('password').addEventListener('input', function(e) {
      const password = e.target.value;
      const strengthFill = document.getElementById('strength-fill');
      const strengthText = document.getElementById('strength-text');
      
      let strength = 0;
      let text = '';
      let color = '';
      
      if (password.length >= 6) strength++;
      if (password.length >= 10) strength++;
      if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
      if (/\d/.test(password)) strength++;
      if (/[^a-zA-Z0-9]/.test(password)) strength++;
      
      switch(strength) {
        case 0:
        case 1:
          text = 'Weak';
          color = '#ef4444';
          break;
        case 2:
          text = 'Fair';
          color = '#f59e0b';
          break;
        case 3:
          text = 'Good';
          color = '#3b82f6';
          break;
        case 4:
        case 5:
          text = 'Strong';
          color = '#10b981';
          break;
      }
      
      strengthFill.style.width = `${(strength / 5) * 100}%`;
      strengthFill.style.background = color;
      strengthText.textContent = text;
      strengthText.style.color = color;
    });

    // Validate passwords match
    document.getElementById('confirm-password').addEventListener('input', function(e) {
      const password = document.getElementById('password').value;
      const confirmPassword = e.target.value;
      
      if (confirmPassword && password !== confirmPassword) {
        e.target.setCustomValidity('Passwords do not match');
        e.target.style.borderColor = '#ef4444';
      } else {
        e.target.setCustomValidity('');
        e.target.style.borderColor = '';
      }
    });

    // Handle Signup
    async function handleSignup(e) {
      e.preventDefault();
      
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      const terms = document.getElementById('terms').checked;
      
      // Validation
      if (!terms) {
        showToast('Please accept the Terms & Conditions', 'error');
        return;
      }
      
      if (password !== confirmPassword) {
        showToast('Passwords do not match', 'error');
        return;
      }
      
      if (password.length < 6) {
        showToast('Password must be at least 6 characters', 'error');
        return;
      }
      
      // Check password strength
      if (!/(?=.*[A-Za-z])(?=.*\d)/.test(password)) {
        showToast('Password must contain at least one letter and one number', 'error');
        return;
      }
      
      const btn = document.getElementById('signup-btn');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
      
      try {
        const response = await fetch('/api/auth?type=signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            name, 
            email, 
            password,
            phone: phone || null
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          localStorage.setItem('kidocart_token', data.token);
          localStorage.setItem('kidocart_currentUser', JSON.stringify(data.user));
          
          showToast('Account created successfully!', 'success');
          
          // Redirect to home or redirect parameter
          const redirect = new URLSearchParams(window.location.search).get('redirect');
          setTimeout(() => {
            window.location.href = redirect || 'index.html';
          }, 1500);
        } else {
          throw new Error(data.error || 'Signup failed');
        }
      } catch (error) {
        showToast(error.message, 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
      }
    }

    // Google Signup
    async function handleGoogleSignup(response) {
      try {
        const res = await fetch('/api/auth/google', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ credential: response.credential })
        });
        
        const data = await res.json();
        
        if (res.ok) {
          localStorage.setItem('kidocart_token', data.token);
          localStorage.setItem('kidocart_currentUser', JSON.stringify(data.user));
          
          showToast('Account created successfully with Google!', 'success');
          
          const redirect = new URLSearchParams(window.location.search).get('redirect');
          setTimeout(() => {
            window.location.href = redirect || 'index.html';
          }, 1500);
        } else {
          throw new Error(data.error || 'Google signup failed');
        }
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast show ${type}`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Check if already logged in
    if (localStorage.getItem('kidocart_token')) {
      window.location.href = 'index.html';
    }
  </script>
</body>
</html>
