<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - KidoCart</title>
  <link rel="icon" type="image/png" href="/logo.png">
  <link rel="stylesheet" href="css/auth.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div class="auth-page">
    <div class="auth-container">
      <!-- Left Side - Branding -->
      <div class="auth-branding">
        <a href="index.html" class="logo">
          <i class="fas fa-baby"></i>
          Kido<span>Cart</span>
        </a>
        <h1>Welcome Back!</h1>
        <p>Login to access your account and continue shopping for your little ones.</p>
        <div class="branding-features">
          <div class="feature">
            <i class="fas fa-check-circle"></i>
            <span>Premium Quality Products</span>
          </div>
          <div class="feature">
            <i class="fas fa-check-circle"></i>
            <span>Secure Payments</span>
          </div>
          <div class="feature">
            <i class="fas fa-check-circle"></i>
            <span>Fast Delivery</span>
          </div>
        </div>
      </div>

      <!-- Right Side - Login Form -->
      <div class="auth-form-container">
        <div class="auth-form">
          <h2>Login to Your Account</h2>
          <p class="auth-subtitle">Choose your preferred login method</p>

          <!-- Login Method Tabs -->
          <div class="login-tabs">
            <button class="tab-btn active" data-tab="email" onclick="switchTab('email')">
              <i class="fas fa-envelope"></i> Email
            </button>
            <button class="tab-btn" data-tab="phone" onclick="switchTab('phone')">
              <i class="fas fa-mobile-alt"></i> Phone
            </button>
          </div>

          <!-- Email Login Tab -->
          <div id="email-tab" class="tab-content active">
            <!-- Email/Password Login -->
            <div id="email-password-form">
              <form onsubmit="handleEmailLogin(event)">
                <div class="form-group">
                  <label for="email">Email Address</label>
                  <div class="input-group">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="email" placeholder="your@email.com" required>
                  </div>
                </div>

                <div class="form-group">
                  <label for="password">Password</label>
                  <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="password" placeholder="Enter your password" required>
                    <button type="button" class="toggle-password" onclick="togglePassword('password')">
                      <i class="fas fa-eye"></i>
                    </button>
                  </div>
                </div>

                <button type="submit" class="btn btn-primary" id="login-btn">
                  <i class="fas fa-sign-in-alt"></i> Login
                </button>
              </form>

              <div class="divider">
                <span>OR</span>
              </div>

              <button class="btn btn-secondary" onclick="switchToOTPLogin()">
                <i class="fas fa-key"></i> Login with OTP
              </button>
            </div>

            <!-- Email OTP Login -->
            <div id="email-otp-form" style="display: none;">
              <form onsubmit="handleSendEmailOTP(event)">
                <div class="form-group">
                  <label for="email-otp">Email Address</label>
                  <div class="input-group">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="email-otp" placeholder="your@email.com" required>
                  </div>
                </div>

                <button type="submit" class="btn btn-primary" id="send-otp-btn">
                  <i class="fas fa-paper-plane"></i> Send OTP
                </button>
              </form>

              <!-- OTP Input (hidden initially) -->
              <div id="otp-input-section" style="display: none;">
                <div class="form-group">
                  <label>Enter OTP</label>
                  <div class="otp-inputs">
                    <input type="text" maxlength="1" class="otp-digit" id="otp1" oninput="moveToNext(this, 'otp2')" onkeydown="moveToPrev(event, this, null)">
                    <input type="text" maxlength="1" class="otp-digit" id="otp2" oninput="moveToNext(this, 'otp3')" onkeydown="moveToPrev(event, this, 'otp1')">
                    <input type="text" maxlength="1" class="otp-digit" id="otp3" oninput="moveToNext(this, 'otp4')" onkeydown="moveToPrev(event, this, 'otp2')">
                    <input type="text" maxlength="1" class="otp-digit" id="otp4" oninput="moveToNext(this, 'otp5')" onkeydown="moveToPrev(event, this, 'otp3')">
                    <input type="text" maxlength="1" class="otp-digit" id="otp5" oninput="moveToNext(this, 'otp6')" onkeydown="moveToPrev(event, this, 'otp4')">
                    <input type="text" maxlength="1" class="otp-digit" id="otp6" oninput="verifyEmailOTP()" onkeydown="moveToPrev(event, this, 'otp5')">
                  </div>
                </div>

                <div class="otp-timer" id="otp-timer">
                  Resend OTP in <span id="timer">60</span>s
                </div>

                <button type="button" class="btn btn-link" id="resend-otp-btn" onclick="resendOTP()" style="display: none;">
                  Resend OTP
                </button>
              </div>

              <button type="button" class="btn btn-outline" onclick="switchToPasswordLogin()">
                <i class="fas fa-arrow-left"></i> Back to Password Login
              </button>
            </div>
          </div>

          <!-- Phone Login Tab -->
          <div id="phone-tab" class="tab-content">
            <form onsubmit="handlePhoneLogin(event)">
              <div class="form-group">
                <label for="phone">Phone Number</label>
                <div class="input-group">
                  <i class="fas fa-mobile-alt"></i>
                  <input type="tel" id="phone-number" placeholder="Enter 10-digit mobile number" maxlength="10" pattern="[6-9][0-9]{9}" required>
                </div>
                <small>We'll send you an OTP to verify your number</small>
              </div>

              <button type="submit" class="btn btn-primary" id="phone-otp-btn">
                <i class="fas fa-paper-plane"></i> Send OTP
              </button>
            </form>

            <!-- Phone OTP Input -->
            <div id="phone-otp-section" style="display: none;">
              <div class="form-group">
                <label>Enter OTP</label>
                <div class="otp-inputs">
                  <input type="text" maxlength="1" class="otp-digit" id="phone-otp1" oninput="moveToNext(this, 'phone-otp2')" onkeydown="moveToPrev(event, this, null)">
                  <input type="text" maxlength="1" class="otp-digit" id="phone-otp2" oninput="moveToNext(this, 'phone-otp3')" onkeydown="moveToPrev(event, this, 'phone-otp1')">
                  <input type="text" maxlength="1" class="otp-digit" id="phone-otp3" oninput="moveToNext(this, 'phone-otp4')" onkeydown="moveToPrev(event, this, 'phone-otp2')">
                  <input type="text" maxlength="1" class="otp-digit" id="phone-otp4" oninput="moveToNext(this, 'phone-otp5')" onkeydown="moveToPrev(event, this, 'phone-otp3')">
                  <input type="text" maxlength="1" class="otp-digit" id="phone-otp5" oninput="moveToNext(this, 'phone-otp6')" onkeydown="moveToPrev(event, this, 'phone-otp4')">
                  <input type="text" maxlength="1" class="otp-digit" id="phone-otp6" oninput="verifyPhoneOTP()" onkeydown="moveToPrev(event, this, 'phone-otp5')">
                </div>
              </div>

              <div class="otp-timer" id="phone-otp-timer">
                Resend OTP in <span id="phone-timer">60</span>s
              </div>

              <button type="button" class="btn btn-link" id="phone-resend-btn" onclick="resendPhoneOTP()" style="display: none;">
                Resend OTP
              </button>
            </div>
          </div>

          <!-- Google Login -->
          <div class="divider">
            <span>OR CONTINUE WITH</span>
          </div>

          <div id="google-signin-button"></div>

          <!-- Signup Link -->
          <div class="auth-footer">
            <p>Don't have an account? <a href="signup.html">Sign up</a></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <script>
    // Initialize Google Sign-In
    function initGoogleSignIn() {
      if (typeof google !== 'undefined') {
        google.accounts.id.initialize({
          client_id: '163244508840-kcersqu6gr3mg2kas71enpr07o3s4vbv.apps.googleusercontent.com', // Replace with your Google Client ID
          callback: handleGoogleLogin,
          auto_select: false
        });

        google.accounts.id.renderButton(
          document.getElementById('google-signin-button'),
          { 
            theme: 'outline', 
            size: 'large',
            width: '100%',
            text: 'continue_with',
            shape: 'rectangular'
          }
        );
      }
    }

    // Load Google Sign-In when page loads
    window.onload = function() {
      initGoogleSignIn();
    };

    // Switch tabs
    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
      document.getElementById(`${tab}-tab`).classList.add('active');
    }

    // Switch to OTP login
    function switchToOTPLogin() {
      document.getElementById('email-password-form').style.display = 'none';
      document.getElementById('email-otp-form').style.display = 'block';
    }

    // Switch to password login
    function switchToPasswordLogin() {
      document.getElementById('email-password-form').style.display = 'block';
      document.getElementById('email-otp-form').style.display = 'none';
      document.getElementById('otp-input-section').style.display = 'none';
    }

    // Toggle password visibility
    function togglePassword(inputId) {
      const input = document.getElementById(inputId);
      const icon = event.currentTarget.querySelector('i');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    }

    // Email/Password Login
    async function handleEmailLogin(e) {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const btn = document.getElementById('login-btn');
      
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
      
      try {
        const response = await fetch('/api/auth?type=login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          localStorage.setItem('kidocart_token', data.token);
          localStorage.setItem('kidocart_currentUser', JSON.stringify(data.user));
          
          showToast('Login successful!', 'success');
          
          const redirect = new URLSearchParams(window.location.search).get('redirect');
          setTimeout(() => {
            window.location.href = redirect || 'index.html';
          }, 1000);
        } else {
          throw new Error(data.error || 'Login failed');
        }
      } catch (error) {
        showToast(error.message, 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
      }
    }

    // Send Email OTP
    let otpTimer;
    async function handleSendEmailOTP(e) {
      e.preventDefault();
      
      const email = document.getElementById('email-otp').value;
      const btn = document.getElementById('send-otp-btn');
      
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
      
      try {
        const response = await fetch('/api/auth?type=send-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showToast('OTP sent to your email!', 'success');
          document.getElementById('otp-input-section').style.display = 'block';
          btn.style.display = 'none';
          
          // Start timer
          startOTPTimer('timer', 'resend-otp-btn');
          
          // Focus first OTP input
          document.getElementById('otp1').focus();
        } else {
          throw new Error(data.error || 'Failed to send OTP');
        }
      } catch (error) {
        showToast(error.message, 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane"></i> Send OTP';
      }
    }

    // OTP Timer
    function startOTPTimer(timerElementId, resendButtonId) {
      let timeLeft = 60;
      const timerEl = document.getElementById(timerElementId);
      const resendBtn = document.getElementById(resendButtonId);
      
      document.getElementById('otp-timer').style.display = 'block';
      resendBtn.style.display = 'none';
      
      otpTimer = setInterval(() => {
        timeLeft--;
        timerEl.textContent = timeLeft;
        
        if (timeLeft <= 0) {
          clearInterval(otpTimer);
          document.getElementById('otp-timer').style.display = 'none';
          resendBtn.style.display = 'block';
        }
      }, 1000);
    }

    // Move to next OTP input
    function moveToNext(current, nextId) {
      if (current.value.length === 1 && nextId) {
        document.getElementById(nextId).focus();
      }
    }

    // Move to previous OTP input
    function moveToPrev(event, current, prevId) {
      if (event.key === 'Backspace' && current.value === '' && prevId) {
        document.getElementById(prevId).focus();
      }
    }

    // Verify Email OTP
    async function verifyEmailOTP() {
      const otp = ['otp1', 'otp2', 'otp3', 'otp4', 'otp5', 'otp6']
        .map(id => document.getElementById(id).value)
        .join('');
      
      if (otp.length !== 6) return;
      
      const email = document.getElementById('email-otp').value;
      
      try {
        const response = await fetch('/api/auth?type=verify-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, otp })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          localStorage.setItem('kidocart_token', data.token);
          localStorage.setItem('kidocart_currentUser', JSON.stringify(data.user));
          
          showToast('Login successful!', 'success');
          
          const redirect = new URLSearchParams(window.location.search).get('redirect');
          setTimeout(() => {
            window.location.href = redirect || 'index.html';
          }, 1000);
        } else {
          throw new Error(data.error || 'Invalid OTP');
        }
      } catch (error) {
        showToast(error.message, 'error');
        // Clear OTP inputs
        ['otp1', 'otp2', 'otp3', 'otp4', 'otp5', 'otp6'].forEach(id => {
          document.getElementById(id).value = '';
        });
        document.getElementById('otp1').focus();
      }
    }

    // Resend OTP
    function resendOTP() {
      handleSendEmailOTP({ preventDefault: () => {} });
    }

    // Phone Login
    async function handlePhoneLogin(e) {
      e.preventDefault();
      
      const phone = document.getElementById('phone-number').value;
      const btn = document.getElementById('phone-otp-btn');
      
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
      
      try {
        const response = await fetch('/api/auth?type=send-phone-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showToast('OTP sent to your phone!', 'success');
          document.getElementById('phone-otp-section').style.display = 'block';
          btn.style.display = 'none';
          
          // Start timer
          startPhoneOTPTimer();
          
          // Focus first input
          document.getElementById('phone-otp1').focus();
        } else {
          throw new Error(data.error || 'Failed to send OTP');
        }
      } catch (error) {
        showToast(error.message, 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane"></i> Send OTP';
      }
    }

    function startPhoneOTPTimer() {
      let timeLeft = 60;
      const timerEl = document.getElementById('phone-timer');
      const resendBtn = document.getElementById('phone-resend-btn');
      
      document.getElementById('phone-otp-timer').style.display = 'block';
      resendBtn.style.display = 'none';
      
      const timer = setInterval(() => {
        timeLeft--;
        timerEl.textContent = timeLeft;
        
        if (timeLeft <= 0) {
          clearInterval(timer);
          document.getElementById('phone-otp-timer').style.display = 'none';
          resendBtn.style.display = 'block';
        }
      }, 1000);
    }

    // Verify Phone OTP
    async function verifyPhoneOTP() {
      const otp = ['phone-otp1', 'phone-otp2', 'phone-otp3', 'phone-otp4', 'phone-otp5', 'phone-otp6']
        .map(id => document.getElementById(id).value)
        .join('');
      
      if (otp.length !== 6) return;
      
      const phone = document.getElementById('phone-number').value;
      
      showToast('Phone OTP verification - Coming Soon!', 'info');
      // TODO: Implement phone OTP verification API
    }

    function resendPhoneOTP() {
      handlePhoneLogin({ preventDefault: () => {} });
    }

    // Google Login
    async function handleGoogleLogin(response) {
      try {
        const res = await fetch('/api/auth?type=google', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ credential: response.credential })
        });
        
        const data = await res.json();
        
        if (res.ok) {
          localStorage.setItem('kidocart_token', data.token);
          localStorage.setItem('kidocart_currentUser', JSON.stringify(data.user));
          
          showToast('Google login successful!', 'success');
          
          const redirect = new URLSearchParams(window.location.search).get('redirect');
          setTimeout(() => {
            window.location.href = redirect || 'index.html';
          }, 1000);
        } else {
          throw new Error(data.error || 'Google login failed');
        }
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    // Toast
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast show ${type}`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Check if already logged in
    if (localStorage.getItem('kidocart_token')) {
      const redirect = new URLSearchParams(window.location.search).get('redirect');
      window.location.href = redirect || 'index.html';
    }
  </script>
</body>
</html>
