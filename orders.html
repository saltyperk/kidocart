<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Orders - KidoCart</title>
  <link rel="icon" type="image/png" href="/logo.png">
  <link rel="stylesheet" href="css/orders.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <!-- HEADER (Same as index.html) -->
  <header class="header" id="header">
    <div class="header-container">
      <a href="index.html" class="logo">
        <i class="fas fa-baby"></i>
        Kido<span>Cart</span>
      </a>
      
      <div class="search-container">
        <div class="search-bar">
          <input type="text" id="search-input" placeholder="Search for products, brands, categories...">
          <button class="search-btn" id="search-btn">
            <i class="fas fa-search"></i>
            <span>Search</span>
          </button>
        </div>
      </div>
      
      <div class="header-actions">
        <a href="account.html" class="header-action">
          <i class="fas fa-user"></i>
          <span>Account</span>
        </a>
        <a href="wishlist.html" class="header-action">
          <i class="fas fa-heart"></i>
          <span>Wishlist</span>
          <span class="badge" id="wishlist-count">0</span>
        </a>
        <a href="cart.html" class="header-action">
          <i class="fas fa-shopping-bag"></i>
          <span>Cart</span>
          <span class="badge" id="cart-count">0</span>
        </a>
      </div>
    </div>
  </header>

  <!-- ORDERS PAGE -->
  <div class="orders-page">
    <div class="orders-container">
      <!-- Page Header -->
      <div class="page-header">
        <div>
          <h1>My Orders</h1>
          <p id="orders-subtitle">Track and manage your orders</p>
        </div>
        <div class="header-actions-buttons">
          <a href="products.html" class="btn btn-primary">
            <i class="fas fa-shopping-bag"></i>
            Continue Shopping
          </a>
        </div>
      </div>

      <!-- Order Filters -->
      <div class="order-filters">
        <button class="filter-btn active" data-filter="all" onclick="filterOrders('all')">
          All Orders
        </button>
        <button class="filter-btn" data-filter="pending" onclick="filterOrders('pending')">
          Pending
        </button>
        <button class="filter-btn" data-filter="processing" onclick="filterOrders('processing')">
          Processing
        </button>
        <button class="filter-btn" data-filter="shipped" onclick="filterOrders('shipped')">
          Shipped
        </button>
        <button class="filter-btn" data-filter="delivered" onclick="filterOrders('delivered')">
          Delivered
        </button>
        <button class="filter-btn" data-filter="cancelled" onclick="filterOrders('cancelled')">
          Cancelled
        </button>
      </div>

      <!-- Orders Content -->
      <div id="orders-content">
        <!-- Loading State -->
        <div class="loading-state" id="loading-state">
          <div class="loading-skeleton"></div>
          <div class="loading-skeleton"></div>
          <div class="loading-skeleton"></div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="empty-state" style="display: none;">
          <i class="fas fa-shopping-bag"></i>
          <h2>No orders yet</h2>
          <p>Start shopping to see your orders here</p>
          <a href="products.html" class="btn btn-primary">
            <i class="fas fa-shopping-cart"></i>
            Start Shopping
          </a>
        </div>

        <!-- Orders List -->
        <div class="orders-list" id="orders-list" style="display: none;">
          <!-- Orders will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Order Details Modal -->
  <div class="modal" id="order-modal">
    <div class="modal-content large">
      <div class="modal-header">
        <h2>Order Details</h2>
        <button class="modal-close" onclick="closeOrderModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body" id="order-details-content">
        <!-- Order details will load here -->
      </div>
    </div>
  </div>

  <!-- Cancel Order Confirmation Modal -->
  <div class="modal" id="cancel-modal">
    <div class="modal-content">
      <h3>Cancel Order?</h3>
      <p>Are you sure you want to cancel this order? This action cannot be undone.</p>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeCancelModal()">No, Keep It</button>
        <button class="btn btn-primary" onclick="confirmCancelOrder()">Yes, Cancel Order</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <script src="js/app.js"></script>
  <script>
    // Global variables
    let allOrders = [];
    let currentFilter = 'all';
    let orderToCancel = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', async function() {
      await checkLoginAndLoadOrders();
      updateHeaderCounts();
    });

    // Check login and load orders
    async function checkLoginAndLoadOrders() {
      const token = localStorage.getItem('kidocart_token');
      
      if (!token) {
        showLoginRequired();
        return;
      }

      await loadOrders();
    }

    // Load orders from API
    async function loadOrders() {
      const token = localStorage.getItem('kidocart_token');

      try {
        document.getElementById('loading-state').style.display = 'grid';
        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('orders-list').style.display = 'none';

        const response = await fetch('/api/orders', {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (response.status === 401) {
          localStorage.removeItem('kidocart_token');
          showLoginRequired();
          return;
        }

        if (response.ok) {
          allOrders = await response.json();

          if (allOrders.length > 0) {
            displayOrders();
          } else {
            showEmptyState();
          }
        } else {
          throw new Error('Failed to load orders');
        }
      } catch (error) {
        console.error('Error loading orders:', error);
        showToast('Failed to load orders', 'error');
        showEmptyState();
      } finally {
        document.getElementById('loading-state').style.display = 'none';
      }
    }

    // Display orders
    function displayOrders() {
      const container = document.getElementById('orders-list');
      const subtitle = document.getElementById('orders-subtitle');
      
      // Filter orders
      let filteredOrders = currentFilter === 'all' 
        ? allOrders 
        : allOrders.filter(order => order.status === currentFilter);

      subtitle.textContent = `${filteredOrders.length} ${filteredOrders.length === 1 ? 'order' : 'orders'}`;

      if (filteredOrders.length === 0) {
        container.innerHTML = `
          <div class="no-orders-filtered">
            <i class="fas fa-filter"></i>
            <h3>No ${currentFilter} orders</h3>
            <p>You don't have any ${currentFilter} orders at the moment</p>
          </div>
        `;
        container.style.display = 'block';
        return;
      }

      container.innerHTML = filteredOrders.map(order => {
        const orderDate = new Date(order.createdAt).toLocaleDateString('en-IN', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });

        const deliveryDate = order.deliveryDate 
          ? new Date(order.deliveryDate).toLocaleDateString('en-IN', {
              year: 'numeric',
              month: 'short',
              day: 'numeric'
            })
          : 'Not specified';

        const statusClass = getStatusClass(order.status);
        const statusIcon = getStatusIcon(order.status);

        return `
          <div class="order-card" data-status="${order.status}">
            <div class="order-header">
              <div class="order-id-section">
                <h3>Order #${order._id.slice(-8).toUpperCase()}</h3>
                <span class="order-date">
                  <i class="fas fa-calendar"></i>
                  Placed on ${orderDate}
                </span>
              </div>
              <span class="order-status ${statusClass}">
                <i class="${statusIcon}"></i>
                ${formatStatus(order.status)}
              </span>
            </div>

            <div class="order-items-preview">
              ${order.items.slice(0, 3).map(item => {
                const product = item.productId || item.product;
                const imageUrl = product?.images?.[0] || 'https://via.placeholder.com/80x80?text=No+Image';
                
                return `
                  <div class="order-item-preview">
                    <img src="${imageUrl}" alt="${product?.name || 'Product'}" onerror="this.src='https://via.placeholder.com/80x80?text=No+Image'">
                    <div class="item-preview-info">
                      <h4>${product?.name || 'Product'}</h4>
                      <p>Qty: ${item.quantity} × ₹${item.price.toLocaleString('en-IN')}</p>
                    </div>
                  </div>
                `;
              }).join('')}
              ${order.items.length > 3 ? `
                <div class="more-items">
                  +${order.items.length - 3} more ${order.items.length - 3 === 1 ? 'item' : 'items'}
                </div>
              ` : ''}
            </div>

            <div class="order-footer">
              <div class="order-total-section">
                <span class="total-label">Total Amount</span>
                <span class="total-amount">₹${order.total.toLocaleString('en-IN')}</span>
              </div>

              <div class="order-actions">
                <button class="btn btn-secondary btn-sm" onclick="viewOrderDetails('${order._id}')">
                  <i class="fas fa-eye"></i>
                  View Details
                </button>
                
                ${order.status === 'pending' || order.status === 'processing' ? `
                  <button class="btn btn-outline btn-sm" onclick="cancelOrder('${order._id}')">
                    <i class="fas fa-times"></i>
                    Cancel
                  </button>
                ` : ''}
                
                ${order.status === 'delivered' ? `
                  <button class="btn btn-primary btn-sm" onclick="reorder('${order._id}')">
                    <i class="fas fa-redo"></i>
                    Reorder
                  </button>
                ` : ''}
              </div>
            </div>

            ${order.trackingNumber ? `
              <div class="tracking-info">
                <i class="fas fa-shipping-fast"></i>
                <span>Tracking: <strong>${order.trackingNumber}</strong></span>
                <button class="btn-link" onclick="trackOrder('${order.trackingNumber}')">Track Package</button>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');

      container.style.display = 'block';
    }

    // Filter orders
    function filterOrders(status) {
      currentFilter = status;
      
      // Update active filter button
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-filter="${status}"]`).classList.add('active');

      displayOrders();
    }

    // View order details
    async function viewOrderDetails(orderId) {
      const order = allOrders.find(o => o._id === orderId);
      
      if (!order) {
        showToast('Order not found', 'error');
        return;
      }

      const orderDate = new Date(order.createdAt).toLocaleDateString('en-IN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      const deliveryDate = order.deliveryDate 
        ? new Date(order.deliveryDate).toLocaleDateString('en-IN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          })
        : 'Not specified';

      const statusClass = getStatusClass(order.status);

      const content = document.getElementById('order-details-content');
      content.innerHTML = `
        <div class="order-details-header">
          <div>
            <h3>Order #${order._id.slice(-8).toUpperCase()}</h3>
            <p class="order-detail-date">${orderDate}</p>
          </div>
          <span class="order-status ${statusClass}">
            ${formatStatus(order.status)}
          </span>
        </div>

        <div class="order-details-grid">
          <!-- Shipping Address -->
          <div class="detail-section">
            <h4><i class="fas fa-map-marker-alt"></i> Shipping Address</h4>
            <div class="address-box">
              <p><strong>${order.shippingAddress.firstName} ${order.shippingAddress.lastName}</strong></p>
              <p>${order.shippingAddress.address}</p>
              ${order.shippingAddress.apartment ? `<p>${order.shippingAddress.apartment}</p>` : ''}
              <p>${order.shippingAddress.city}, ${order.shippingAddress.state} - ${order.shippingAddress.pincode}</p>
              <p><i class="fas fa-phone"></i> ${order.phone}</p>
            </div>
          </div>

          <!-- Payment Info -->
          <div class="detail-section">
            <h4><i class="fas fa-credit-card"></i> Payment Information</h4>
            <div class="info-box">
              <div class="info-row">
                <span>Payment Method</span>
                <strong>${formatPaymentMethod(order.paymentMethod)}</strong>
              </div>
              <div class="info-row">
                <span>Payment Status</span>
                <strong class="${order.paymentStatus === 'paid' ? 'text-success' : 'text-warning'}">
                  ${order.paymentStatus === 'paid' ? 'Paid' : 'Pending'}
                </strong>
              </div>
              ${order.transactionId ? `
                <div class="info-row">
                  <span>Transaction ID</span>
                  <strong>${order.transactionId}</strong>
                </div>
              ` : ''}
            </div>
          </div>
        </div>

        <!-- Order Items -->
        <div class="detail-section">
          <h4><i class="fas fa-box"></i> Order Items</h4>
          <div class="order-items-detailed">
            ${order.items.map(item => {
              const product = item.productId || item.product;
              const imageUrl = product?.images?.[0] || 'https://via.placeholder.com/80x80?text=No+Image';
              const itemTotal = item.price * item.quantity;

              return `
                <div class="order-item-detailed">
                  <img src="${imageUrl}" alt="${product?.name || 'Product'}" onerror="this.src='https://via.placeholder.com/80x80?text=No+Image'">
                  <div class="item-detailed-info">
                    <h5>${product?.name || 'Product'}</h5>
                    ${item.size || item.color ? `
                      <div class="item-variants">
                        ${item.size ? `<span><i class="fas fa-ruler"></i> ${item.size}</span>` : ''}
                        ${item.color ? `<span><i class="fas fa-palette"></i> ${item.color}</span>` : ''}
                      </div>
                    ` : ''}
                    <p class="item-price-detail">₹${item.price.toLocaleString('en-IN')} × ${item.quantity}</p>
                  </div>
                  <div class="item-total-price">₹${itemTotal.toLocaleString('en-IN')}</div>
                </div>
              `;
            }).join('')}
          </div>
        </div>

        <!-- Order Summary -->
        <div class="detail-section">
          <h4><i class="fas fa-receipt"></i> Order Summary</h4>
          <div class="order-summary-box">
            <div class="summary-row">
              <span>Subtotal</span>
              <span>₹${(order.total - 50).toLocaleString('en-IN')}</span>
            </div>
            <div class="summary-row">
              <span>Shipping</span>
              <span>${order.total >= 500 ? 'FREE' : '₹50'}</span>
            </div>
            <div class="summary-divider"></div>
            <div class="summary-row total">
              <strong>Total</strong>
              <strong>₹${order.total.toLocaleString('en-IN')}</strong>
            </div>
          </div>
        </div>

        ${order.trackingNumber ? `
          <div class="tracking-section">
            <button class="btn btn-primary" onclick="trackOrder('${order.trackingNumber}')">
              <i class="fas fa-shipping-fast"></i>
              Track Your Order
            </button>
          </div>
        ` : ''}
      `;

      document.getElementById('order-modal').classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    // Cancel order
    function cancelOrder(orderId) {
      orderToCancel = orderId;
      document.getElementById('cancel-modal').classList.add('show');
    }

    // Confirm cancel order
    async function confirmCancelOrder() {
      if (!orderToCancel) return;

      const token = localStorage.getItem('kidocart_token');

      try {
        const response = await fetch(`/api/orders/${orderToCancel}/cancel`, {
          method: 'PUT',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token 
          }
        });

        if (response.ok) {
          showToast('Order cancelled successfully', 'success');
          await loadOrders();
        } else {
          const error = await response.json();
          throw new Error(error.error || 'Failed to cancel order');
        }
      } catch (error) {
        console.error('Error cancelling order:', error);
        showToast(error.message || 'Failed to cancel order', 'error');
      } finally {
        closeCancelModal();
      }
    }

    // Reorder
    async function reorder(orderId) {
      const order = allOrders.find(o => o._id === orderId);
      
      if (!order) {
        showToast('Order not found', 'error');
        return;
      }

      const token = localStorage.getItem('kidocart_token');

      try {
        // Add all items to cart
        for (const item of order.items) {
          const productId = item.productId?._id || item.productId;
          
          await fetch('/api/cart', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
              productId: productId,
              quantity: item.quantity,
              size: item.size,
              color: item.color
            })
          });
        }

        showToast('Items added to cart!', 'success');
        setTimeout(() => {
          window.location.href = 'cart.html';
        }, 1500);
      } catch (error) {
        console.error('Error reordering:', error);
        showToast('Failed to reorder', 'error');
      }
    }

    // Track order
    function trackOrder(trackingNumber) {
      // Open tracking in new window - replace with your courier's tracking URL
      const trackingUrl = `https://www.delhivery.com/track/package/${trackingNumber}`;
      window.open(trackingUrl, '_blank');
    }

    // Helper functions
    function getStatusClass(status) {
      const classes = {
        'pending': 'status-pending',
        'processing': 'status-processing',
        'shipped': 'status-shipped',
        'delivered': 'status-delivered',
        'cancelled': 'status-cancelled',
        'failed': 'status-failed'
      };
      return classes[status] || 'status-pending';
    }

    function getStatusIcon(status) {
      const icons = {
        'pending': 'fas fa-clock',
        'processing': 'fas fa-cog fa-spin',
        'shipped': 'fas fa-shipping-fast',
        'delivered': 'fas fa-check-circle',
        'cancelled': 'fas fa-times-circle',
        'failed': 'fas fa-exclamation-circle'
      };
      return icons[status] || 'fas fa-clock';
    }

    function formatStatus(status) {
      return status.charAt(0).toUpperCase() + status.slice(1);
    }

    function formatPaymentMethod(method) {
      const methods = {
        'phonepe': 'PhonePe',
        'cod': 'Cash on Delivery',
        'card': 'Card',
        'upi': 'UPI',
        'netbanking': 'Net Banking'
      };
      return methods[method] || method;
    }

    // Show empty state
    function showEmptyState() {
      document.getElementById('empty-state').style.display = 'flex';
      document.getElementById('orders-list').style.display = 'none';
      document.getElementById('orders-subtitle').textContent = 'No orders yet';
    }

    // Show login required
    function showLoginRequired() {
      document.getElementById('loading-state').style.display = 'none';
      const emptyState = document.getElementById('empty-state');
      emptyState.innerHTML = `
        <i class="fas fa-user-lock"></i>
        <h2>Login Required</h2>
        <p>Please login to view your orders</p>
        <a href="login.html" class="btn btn-primary">
          <i class="fas fa-sign-in-alt"></i> Login Now
        </a>
      `;
      emptyState.style.display = 'flex';
    }

    // Close modals
    function closeOrderModal() {
      document.getElementById('order-modal').classList.remove('show');
      document.body.style.overflow = '';
    }

    function closeCancelModal() {
      document.getElementById('cancel-modal').classList.remove('show');
      orderToCancel = null;
    }

    // Toast
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast show ${type}`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Search
    function performSearch() {
      const query = document.getElementById('search-input').value.trim();
      if (query) {
        window.location.href = `products.html?search=${encodeURIComponent(query)}`;
      }
    }

    document.getElementById('search-input').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') performSearch();
    });

    document.getElementById('search-btn').addEventListener('click', performSearch);

    // Update header counts
    async function updateHeaderCounts() {
      const token = localStorage.getItem('kidocart_token');
      const cartCountEl = document.getElementById('cart-count');
      const wishlistCountEl = document.getElementById('wishlist-count');
      
      if (token) {
        try {
          const cartResponse = await fetch('/api/cart', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          
          if (cartResponse.ok) {
            const cart = await cartResponse.json();
            const cartCount = cart.items ? cart.items.reduce((sum, item) => sum + item.quantity, 0) : 0;
            cartCountEl.textContent = cartCount;
            cartCountEl.style.display = cartCount > 0 ? 'flex' : 'none';
          }

          const wishlistResponse = await fetch('/api/wishlist', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          
          if (wishlistResponse.ok) {
            const wishlist = await wishlistResponse.json();
            const wishlistCount = wishlist.items ? wishlist.items.length : 0;
            wishlistCountEl.textContent = wishlistCount;
            wishlistCountEl.style.display = wishlistCount > 0 ? 'flex' : 'none';
          }
        } catch (error) {
          console.error('Error updating counts:', error);
        }
      }
    }

    // Header scroll behavior
    let lastScroll = 0;
    const header = document.getElementById('header');

    window.addEventListener('scroll', () => {
      const currentScroll = window.pageYOffset;
      
      if (currentScroll > 10) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }
      
      lastScroll = currentScroll;
    });
  </script>
</body>
</html>
