<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Details - KidoCart</title>
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .product-detail-page { padding: 2rem 1rem; }
    .product-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; }
    .gallery-container { position: sticky; top: 100px; }
    .main-image { width: 100%; height: 500px; border-radius: 20px; overflow: hidden; margin-bottom: 1rem; background: var(--light); display: flex; align-items: center; justify-content: center; }
    .main-image img { width: 100%; height: 100%; object-fit: cover; }
    .thumbnail-list { display: flex; gap: 0.75rem; flex-wrap: wrap; }
    .thumbnail { width: 80px; height: 80px; border-radius: 10px; overflow: hidden; cursor: pointer; border: 3px solid transparent; transition: border-color 0.3s; background: var(--light); }
    .thumbnail:hover, .thumbnail.active { border-color: var(--primary); }
    .thumbnail img { width: 100%; height: 100%; object-fit: cover; }
    .product-title { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
    .product-meta { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .rating-display { display: flex; align-items: center; gap: 0.5rem; }
    .rating-display .stars { color: var(--accent); }
    .price-section { background: var(--pastel-green); padding: 1.5rem; border-radius: 15px; margin: 1.5rem 0; }
    .price-row { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
    .big-price { font-size: 2.5rem; font-weight: 800; color: var(--primary); }
    .old-price { font-size: 1.25rem; color: var(--gray); text-decoration: line-through; }
    .save-badge { background: var(--success); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 600; }
    .stock-status { margin-top: 0.5rem; }
    .stock-status.in-stock { color: var(--success); }
    .stock-status.low-stock { color: var(--warning); }
    .stock-status.out-of-stock { color: var(--danger); }
    .options-section { margin: 1.5rem 0; }
    .option-title { font-weight: 600; margin-bottom: 0.75rem; }
    .size-options, .color-options { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .size-btn, .color-btn { padding: 0.5rem 1rem; border: 2px solid var(--light); border-radius: 10px; background: white; cursor: pointer; transition: all 0.3s; }
    .size-btn:hover, .size-btn.active { border-color: var(--primary); background: var(--pastel-purple); }
    .color-btn { width: 40px; height: 40px; border-radius: 50%; padding: 0; }
    .color-btn.active { box-shadow: 0 0 0 3px var(--primary); }
    .quantity-section { display: flex; align-items: center; gap: 1rem; margin: 1.5rem 0; }
    .qty-control { display: flex; align-items: center; border: 2px solid var(--light); border-radius: 10px; overflow: hidden; }
    .qty-btn { width: 45px; height: 45px; border: none; background: var(--light); cursor: pointer; font-size: 1.25rem; transition: background 0.3s; }
    .qty-btn:hover { background: var(--primary); color: white; }
    .qty-input { width: 60px; height: 45px; border: none; text-align: center; font-size: 1.1rem; font-weight: 600; }
    .action-buttons { display: flex; gap: 1rem; margin: 1.5rem 0; }
    .action-buttons .btn { flex: 1; padding: 1rem; font-size: 1.1rem; }
    .product-features { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin: 1.5rem 0; }
    .feature-item { display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: var(--light); border-radius: 10px; }
    .feature-item i { color: var(--primary); font-size: 1.25rem; }
    .description-section { margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--light); }
    .description-section h3 { margin-bottom: 1rem; }
    .specs-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    .specs-table tr:nth-child(even) { background: var(--light); }
    .specs-table td { padding: 0.75rem 1rem; }
    .specs-table td:first-child { font-weight: 600; width: 40%; }
    .related-products { margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--light); }
    .loading-container { text-align: center; padding: 4rem 2rem; }
    .loading-spinner { width: 60px; height: 60px; border: 5px solid #f3f3f3; border-top: 5px solid #6366f1; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .error-container { text-align: center; padding: 4rem 2rem; }
    .error-container i { font-size: 4rem; color: var(--gray); margin-bottom: 1rem; }
    @media (max-width: 900px) {
      .product-detail-grid { grid-template-columns: 1fr; }
      .gallery-container { position: relative; top: 0; }
      .main-image { height: 350px; }
      .product-features { grid-template-columns: 1fr; }
      .action-buttons { flex-direction: column; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-top container">
      <a href="index.html" class="logo"><i class="fas fa-baby"></i> Kido<span>Cart</span></a>
      <div class="search-bar">
        <input type="text" id="search-input" placeholder="Search for products...">
        <button id="search-btn"><i class="fas fa-search"></i> Search</button>
      </div>
      <div class="header-actions">
        <a href="wishlist.html" class="header-action"><i class="fas fa-heart"></i><span class="wishlist-count" style="display: none;">0</span><span>Wishlist</span></a>
        <a href="cart.html" class="header-action"><i class="fas fa-shopping-cart"></i><span class="cart-count" style="display: none;">0</span><span>Cart</span></a>
        <div id="user-action"><a href="login.html" class="header-action"><i class="fas fa-user"></i><span>Login</span></a></div>
      </div>
    </div>
    <nav class="nav">
      <ul class="nav-list container">
        <li><a href="index.html">Home</a></li>
        <li><a href="products.html">All Products</a></li>
        <li><a href="products.html?category=clothing">Clothing</a></li>
        <li><a href="products.html?category=toys">Toys</a></li>
        <li><a href="products.html?category=feeding">Feeding</a></li>
        <li><a href="products.html?category=gear">Gear & Travel</a></li>
      </ul>
    </nav>
  </header>
  <!-- Breadcrumb -->
  <div class="container" style="padding: 1rem;">
    <nav style="color: var(--gray); font-size: 0.875rem;" id="breadcrumb">
      <a href="index.html" style="color: var(--primary);">Home</a> / 
      <a href="products.html" style="color: var(--primary);">Products</a> / 
      <span id="breadcrumb-product">Loading...</span>
    </nav>
  </div>
  <!-- Product Detail -->
  <main class="container product-detail-page" id="product-container">
    <!-- Loading State -->
    <div class="loading-container" id="loading-state">
      <div class="loading-spinner"></div>
      <h2>Loading Product...</h2>
      <p style="color: var(--gray);">Please wait while we fetch product details</p>
    </div>
  </main>
  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-bottom"><p>&copy; 2024 KidoCart. All rights reserved.</p></div>
    </div>
  </footer>
  <script src="js/data.js"></script>
  <script src="js/app.js"></script>
  <script>
    let currentProduct = null;
    let selectedSize = null;
    let selectedColor = null;
    let quantity = 1;
    // Get product ID from URL
    function getProductIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }
    // Load product from MongoDB
    async function loadProduct() {
      const productId = getProductIdFromURL();
      const container = document.getElementById('product-container');
      
      if (!productId) {
        showError('No product ID specified');
        return;
      }
      try {
        console.log('Loading product:', productId);
        
        // Fetch from MongoDB API
        const response = await fetch(`/api/products?id=${productId}`);
        
        if (!response.ok) {
          throw new Error('Product not found');
        }
        
        currentProduct = await response.json();
        console.log('Product loaded:', currentProduct);
        
        if (!currentProduct || !currentProduct.name) {
          throw new Error('Invalid product data');
        }
        
        // Render the product
        renderProduct();
        
        // Load related products
        loadRelatedProducts();
        
      } catch (error) {
        console.error('Error loading product:', error);
        showError(error.message || 'Failed to load product');
      }
    }
    // Show error state
    function showError(message) {
      const container = document.getElementById('product-container');
      container.innerHTML = `
        <div class="error-container">
          <i class="fas fa-exclamation-circle"></i>
          <h2>Product Not Found</h2>
          <p style="color: var(--gray); margin-bottom: 1.5rem;">${message}</p>
          <a href="products.html" class="btn btn-primary">
            <i class="fas fa-arrow-left"></i> Browse Products
          </a>
        </div>
      `;
    }
    // Render product details
    function renderProduct() {
      const container = document.getElementById('product-container');
      
      // Update page title
      document.title = `${currentProduct.name} - KidoCart`;
      
      // Update breadcrumb
      document.getElementById('breadcrumb-product').textContent = currentProduct.name;
      
      // Get product data
      const productId = currentProduct._id || currentProduct.id;
      
      // Robust Image Handling
      let images = [];
      if (currentProduct.images) {
        if (Array.isArray(currentProduct.images)) {
          images = currentProduct.images.filter(img => img && img.trim() !== '');
        } else if (typeof currentProduct.images === 'string') {
          images = [currentProduct.images];
        }
      }
      // Also check for legacy 'image' field (singular)
      if (images.length === 0 && currentProduct.image) {
        images = [currentProduct.image];
      }
      const firstImage = images.length > 0 ? images[0] : 'https://via.placeholder.com/500x500?text=No+Image';
      
      const ageGroup = typeof AGE_GROUPS !== 'undefined' 
        ? AGE_GROUPS.find(ag => ag.id === currentProduct.ageGroup) 
        : null;
        
      const discount = currentProduct.originalPrice ? Math.round((1 - currentProduct.price / currentProduct.originalPrice) * 100) : 0;
      
      // Render HTML
      container.innerHTML = `
        <div class="product-detail-grid">
          <!-- Gallery -->
          <div class="gallery-container">
            <div class="main-image">
              <img id="main-product-image" src="${firstImage}" alt="${currentProduct.name}" onerror="this.src='https://via.placeholder.com/500x500?text=Image+Not+Found'">
            </div>
            ${images.length > 1 ? `
              <div class="thumbnail-list" id="thumbnail-list">
                ${images.map((img, index) => `
                  <div class="thumbnail ${index === 0 ? 'active' : ''}" onclick="changeMainImage('${img}', this)">
                    <img src="${img}" alt="Thumbnail ${index + 1}" onerror="this.src='https://via.placeholder.com/80x80?text=No+Image'">
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
          <!-- Product Info -->
          <div class="product-info-section">
            <span class="age-badge">${ageGroup ? ageGroup.label : currentProduct.ageGroup || 'All Ages'}</span>
            <h1 class="product-title">${currentProduct.name}</h1>
            
            <div class="product-meta">
              <div class="rating-display">
                <span class="stars">${renderStars(currentProduct.rating || 0)}</span>
                <span>${(currentProduct.rating || 0).toFixed(1)}</span>
                <span style="color: var(--gray);">(${currentProduct.reviewCount || 0} reviews)</span>
              </div>
              <span style="color: var(--gray);">|</span>
              <span style="color: var(--gray);">Brand: <strong>${currentProduct.brand || 'N/A'}</strong></span>
            </div>
            <div class="price-section">
              <div class="price-row">
                <span class="big-price">₹${parseFloat(currentProduct.price).toFixed(0)}</span>
                ${currentProduct.originalPrice ? `<span class="old-price">₹${parseFloat(currentProduct.originalPrice).toFixed(0)}</span>` : ''}
                ${discount > 0 ? `<span class="save-badge">Save ${discount}%</span>` : ''}
              </div>
              <p class="stock-status ${getStockClass(currentProduct)}">${getStockText(currentProduct)}</p>
            </div>
            <!-- Size Options -->
            ${currentProduct.sizes && currentProduct.sizes.length > 0 ? `
              <div class="options-section">
                <p class="option-title">Select Size:</p>
                <div class="size-options">
                  ${currentProduct.sizes.map(size => `
                    <button class="size-btn" onclick="selectSize('${size}', this)">${size}</button>
                  `).join('')}
                </div>
              </div>
            ` : ''}
            <!-- Color Options -->
            ${currentProduct.colors && currentProduct.colors.length > 0 ? `
              <div class="options-section">
                <p class="option-title">Select Color: <span id="selected-color-name"></span></p>
                <div class="color-options">
                  ${currentProduct.colors.map(color => `
                    <button class="color-btn" style="background: ${getColorCode(color)}; border: 2px solid ${color.toLowerCase() === 'white' ? '#ddd' : 'transparent'};" 
                      onclick="selectColor('${color}', this)" title="${color}"></button>
                  `).join('')}
                </div>
              </div>
            ` : ''}
            <!-- Quantity -->
            <div class="quantity-section">
              <span class="option-title">Quantity:</span>
              <div class="qty-control">
                <button class="qty-btn" onclick="changeQuantity(-1)">-</button>
                <input type="number" class="qty-input" id="quantity-input" value="1" min="1" max="${currentProduct.stock || 99}" readonly>
                <button class="qty-btn" onclick="changeQuantity(1)">+</button>
              </div>
              <span style="color: var(--gray); font-size: 0.875rem;">(${currentProduct.stock || 0} available)</span>
            </div>
            <!-- Action Buttons -->
            <div class="action-buttons">
              <button class="btn btn-primary" onclick="handleAddToCartDetail()" ${!currentProduct.availability || currentProduct.stock < 1 ? 'disabled' : ''}>
                <i class="fas fa-shopping-cart"></i> Add to Cart
              </button>
              <button class="btn btn-secondary" onclick="handleBuyNow()" ${!currentProduct.availability || currentProduct.stock < 1 ? 'disabled' : ''}>
                <i class="fas fa-bolt"></i> Buy Now
              </button>
            </div>
            <button class="btn btn-outline w-full" onclick="handleWishlistDetail()">
              <i class="far fa-heart"></i> Add to Wishlist
            </button>
            <!-- Features -->
            <div class="product-features">
              <div class="feature-item">
                <i class="fas fa-truck"></i>
                <div>
                  <strong>Free Shipping</strong>
                  <small style="display: block; color: var(--gray);">Orders over ₹499</small>
                </div>
              </div>
              <div class="feature-item">
                <i class="fas fa-undo"></i>
                <div>
                  <strong>Easy Returns</strong>
                  <small style="display: block; color: var(--gray);">30 day returns</small>
                </div>
              </div>
              <div class="feature-item">
                <i class="fas fa-shield-alt"></i>
                <div>
                  <strong>Secure</strong>
                  <small style="display: block; color: var(--gray);">100% Protected</small>
                </div>
              </div>
            </div>
            <!-- Description -->
            <div class="description-section">
              <h3>Product Description</h3>
              <p>${currentProduct.description || 'No description available.'}</p>
              <table class="specs-table">
                <tr><td>Category</td><td style="text-transform: capitalize;">${currentProduct.category || 'N/A'}</td></tr>
                <tr><td>Age Group</td><td>${ageGroup ? ageGroup.label : currentProduct.ageGroup || 'All Ages'}</td></tr>
                <tr><td>Brand</td><td>${currentProduct.brand || 'N/A'}</td></tr>
                ${currentProduct.sizes && currentProduct.sizes.length > 0 ? `<tr><td>Available Sizes</td><td>${currentProduct.sizes.join(', ')}</td></tr>` : ''}
                ${currentProduct.colors && currentProduct.colors.length > 0 ? `<tr><td>Available Colors</td><td>${currentProduct.colors.join(', ')}</td></tr>` : ''}
              </table>
            </div>
          </div>
        </div>
        <!-- Related Products -->
        <section class="related-products">
          <h2 class="section-title">You May Also <span>Like</span></h2>
          <div class="product-grid" id="related-products">
            <div style="grid-column: 1/-1; text-align: center; padding: 2rem;">
              <div class="loading-spinner" style="width: 40px; height: 40px;"></div>
            </div>
          </div>
        </section>
      `;
    }
    // Get stock status class
    function getStockClass(product) {
      if (!product.availability || product.stock === 0) return 'out-of-stock';
      if (product.stock < 10) return 'low-stock';
      return 'in-stock';
    }
    // Get stock status text
    function getStockText(product) {
      if (!product.availability || product.stock === 0) return '✗ Out of Stock';
      if (product.stock < 10) return `✓ Only ${product.stock} left in stock - order soon!`;
      return '✓ In Stock';
    }
    // Get color code from color name
    function getColorCode(color) {
      const colorMap = {
        'red': '#ef4444', 'blue': '#3b82f6', 'green': '#22c55e', 'pink': '#ec4899',
        'white': '#ffffff', 'black': '#1f2937', 'yellow': '#eab308', 'purple': '#a855f7',
        'brown': '#92400e', 'gray': '#6b7280', 'grey': '#6b7280', 'navy': '#1e3a5a', 
        'orange': '#f97316', 'beige': '#d4c4a8', 'cream': '#fffdd0',
        'natural wood': '#deb887', 'dinosaur': '#22c55e', 'unicorn': '#ec4899', 
        'space': '#1e3a5a', 'princess': '#f472b6'
      };
      return colorMap[color.toLowerCase()] || '#999999';
    }
    // Change main image
    function changeMainImage(src, thumbEl) {
      document.getElementById('main-product-image').src = src;
      document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
      if (thumbEl) thumbEl.classList.add('active');
    }
    // Select size
    function selectSize(size, btn) {
      selectedSize = size;
      document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }
    // Select color
    function selectColor(color, btn) {
      selectedColor = color;
      const colorNameEl = document.getElementById('selected-color-name');
      if (colorNameEl) colorNameEl.textContent = color;
      document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }
    // Change quantity
    function changeQuantity(delta) {
      const newQty = quantity + delta;
      const maxStock = currentProduct.stock || 99;
      if (newQty >= 1 && newQty <= maxStock) {
        quantity = newQty;
        document.getElementById('quantity-input').value = quantity;
      }
    }
    // Add to cart from detail page
    async function handleAddToCartDetail() {
      if (currentProduct.sizes && currentProduct.sizes.length > 0 && !selectedSize) {
        showToast('Please select a size', 'warning');
        return;
      }
      if (currentProduct.colors && currentProduct.colors.length > 0 && !selectedColor) {
        showToast('Please select a color', 'warning');
        return;
      }
      
      const productId = currentProduct._id || currentProduct.id;
      await addToCart(productId, quantity, selectedSize, selectedColor);
    }
    // Buy now
    async function handleBuyNow() {
      if (currentProduct.sizes && currentProduct.sizes.length > 0 && !selectedSize) {
        showToast('Please select a size', 'warning');
        return;
      }
      if (currentProduct.colors && currentProduct.colors.length > 0 && !selectedColor) {
        showToast('Please select a color', 'warning');
        return;
      }
      
      const productId = currentProduct._id || currentProduct.id;
      await addToCart(productId, quantity, selectedSize, selectedColor);
      window.location.href = 'checkout.html';
    }
    // Add to wishlist from detail page
    async function handleWishlistDetail() {
      const productId = currentProduct._id || currentProduct.id;
      await toggleWishlist(productId);
    }
    // Load related products
    async function loadRelatedProducts() {
      try {
        const container = document.getElementById('related-products');
        if (!container) return;
        
        // Fetch products with same category or age group
        const allProducts = await getProducts();
        
        const related = allProducts
          .filter(p => {
            const pId = p._id || p.id;
            const currentId = currentProduct._id || currentProduct.id;
            return pId !== currentId && (p.category === currentProduct.category || p.ageGroup === currentProduct.ageGroup);
          })
          .slice(0, 4);
        
        if (related.length === 0) {
          container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--gray);">No related products found.</p>';
          return;
        }
        
        container.innerHTML = related.map(p => renderProductCard(p)).join('');
        
      } catch (error) {
        console.error('Error loading related products:', error);
      }
    }
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadProduct();
    });
  </script>
</body>
</html>
