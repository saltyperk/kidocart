<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - KidoCart</title>
  <link rel="stylesheet" href="../css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .product-thumb { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; }
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #6366f1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .sync-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #f0fdf4;
      color: #16a34a;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
    }
    .sync-status.syncing {
      background: #fef3c7;
      color: #d97706;
    }
    .sync-status.error {
      background: #fee2e2;
      color: #dc2626;
    }
    .stat-card {
      position: relative;
      overflow: hidden;
    }
    .stat-card::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 100px;
      height: 100px;
      background: rgba(99, 102, 241, 0.1);
      border-radius: 50%;
    }
    .stat-card .icon {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 2rem;
      opacity: 0.2;
    }
    .quick-action {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: var(--light);
      border-radius: 10px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: all 0.3s;
    }
    .quick-action:hover {
      background: var(--pastel-purple);
      transform: translateX(5px);
    }
    .quick-action i {
      width: 40px;
      height: 40px;
      background: white;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
    }
    .activity-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--light);
    }
    .activity-item:last-child {
      border-bottom: none;
    }
    .activity-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
    }
    .activity-icon.order { background: #dbeafe; color: #2563eb; }
    .activity-icon.product { background: #d1fae5; color: #059669; }
    .activity-icon.user { background: #fef3c7; color: #d97706; }
    .chart-placeholder {
      background: linear-gradient(135deg, var(--pastel-purple), var(--pastel-pink));
      border-radius: 15px;
      padding: 2rem;
      text-align: center;
      color: var(--primary);
    }
  </style>
</head>
<body>
  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <div class="logo">
        <i class="fas fa-baby"></i> Kido<span>Cart</span>
        <small style="display: block; font-size: 0.7rem; opacity: 0.7;">Admin Panel</small>
      </div>
      <ul class="admin-nav">
        <li><a href="dashboard.html" class="active"><i class="fas fa-chart-line"></i> Dashboard</a></li>
        <li><a href="products.html"><i class="fas fa-box"></i> Products</a></li>
        <li><a href="orders.html"><i class="fas fa-shopping-bag"></i> Orders</a></li>
        <li><a href="#" onclick="adminLogout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
      </ul>
      <div style="margin-top: auto; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1);">
        <a href="../index.html" style="color: var(--gray); font-size: 0.875rem;">
          <i class="fas fa-external-link-alt"></i> View Store
        </a>
        <div class="sync-status" id="sync-status" style="margin-top: 1rem;">
          <i class="fas fa-cloud"></i>
          <span>Connecting...</span>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <div class="admin-header">
        <div>
          <h1><i class="fas fa-chart-line"></i> Dashboard</h1>
          <p style="color: var(--gray);">Welcome back, Admin! Here's what's happening.</p>
        </div>
        <div style="display: flex; gap: 1rem; align-items: center;">
          <span style="color: var(--gray); font-size: 0.875rem;" id="last-updated">Loading...</span>
          <button class="btn btn-outline btn-sm" onclick="refreshDashboard()">
            <i class="fas fa-sync"></i> Refresh
          </button>
        </div>
      </div>

      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <i class="fas fa-box icon"></i>
          <h3>Total Products</h3>
          <p class="value" id="total-products"><div class="loading-spinner"></div></p>
          <small style="color: var(--gray);" id="products-change">Loading...</small>
        </div>
        <div class="stat-card">
          <i class="fas fa-shopping-bag icon"></i>
          <h3>Total Orders</h3>
          <p class="value" id="total-orders"><div class="loading-spinner"></div></p>
          <small style="color: var(--gray);" id="orders-change">Loading...</small>
        </div>
        <div class="stat-card">
          <i class="fas fa-dollar-sign icon"></i>
          <h3>Total Revenue</h3>
          <p class="value" id="total-revenue"><div class="loading-spinner"></div></p>
          <small style="color: var(--success);" id="revenue-change">Loading...</small>
        </div>
        <div class="stat-card">
          <i class="fas fa-exclamation-triangle icon"></i>
          <h3>Low Stock Items</h3>
          <p class="value" id="low-stock" style="color: var(--danger);"><div class="loading-spinner"></div></p>
          <small style="color: var(--gray);">Need restocking</small>
        </div>
      </div>

      <!-- Main Content Grid -->
      <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
        <!-- Left Column -->
        <div>
          <!-- Recent Orders -->
          <div class="admin-card mb-4">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3><i class="fas fa-shopping-bag" style="color: var(--primary);"></i> Recent Orders</h3>
              <a href="orders.html" class="btn btn-sm btn-outline">View All</a>
            </div>
            <div style="overflow-x: auto;">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Order ID</th>
                    <th>Customer</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody id="recent-orders">
                  <tr>
                    <td colspan="5" style="text-align: center;">
                      <div class="loading-spinner"></div> Loading orders...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Low Stock Products -->
          <div class="admin-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3><i class="fas fa-exclamation-circle" style="color: var(--warning);"></i> Low Stock Alert</h3>
              <a href="products.html" class="btn btn-sm btn-outline">Manage Stock</a>
            </div>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Category</th>
                  <th>Stock</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="low-stock-products">
                <tr>
                  <td colspan="4" style="text-align: center;">
                    <div class="loading-spinner"></div> Loading products...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Right Column -->
        <div>
          <!-- Quick Actions -->
          <div class="admin-card mb-4">
            <h3 style="margin-bottom: 1rem;"><i class="fas fa-bolt" style="color: var(--warning);"></i> Quick Actions</h3>
            
            <a href="products.html" class="quick-action" style="text-decoration: none; color: inherit;">
              <i class="fas fa-plus"></i>
              <div>
                <strong>Add New Product</strong>
                <small style="display: block; color: var(--gray);">Add product to store</small>
              </div>
            </a>
            
            <a href="orders.html" class="quick-action" style="text-decoration: none; color: inherit;">
              <i class="fas fa-truck"></i>
              <div>
                <strong>Process Orders</strong>
                <small style="display: block; color: var(--gray);">Manage pending orders</small>
              </div>
            </a>
            
            <a href="../index.html" target="_blank" class="quick-action" style="text-decoration: none; color: inherit;">
              <i class="fas fa-store"></i>
              <div>
                <strong>View Store</strong>
                <small style="display: block; color: var(--gray);">See customer view</small>
              </div>
            </a>
            
            <div class="quick-action" onclick="refreshDashboard()">
              <i class="fas fa-sync"></i>
              <div>
                <strong>Refresh Data</strong>
                <small style="display: block; color: var(--gray);">Sync with database</small>
              </div>
            </div>
          </div>

          <!-- Top Products -->
          <div class="admin-card mb-4">
            <h3 style="margin-bottom: 1rem;"><i class="fas fa-star" style="color: var(--warning);"></i> Top Products</h3>
            <div id="top-products">
              <div style="text-align: center; padding: 1rem;">
                <div class="loading-spinner"></div>
              </div>
            </div>
          </div>

          <!-- Database Status -->
          <div class="admin-card">
            <h3 style="margin-bottom: 1rem;"><i class="fas fa-database" style="color: var(--primary);"></i> Database Status</h3>
            <div id="db-status">
              <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--light);">
                <span>Products</span>
                <strong id="db-products">-</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--light);">
                <span>Orders</span>
                <strong id="db-orders">-</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--light);">
                <span>Users</span>
                <strong id="db-users">-</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                <span>Status</span>
                <strong id="db-connection" style="color: var(--success);">Checking...</strong>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Check admin auth
    if (!localStorage.getItem('kidsstore_adminLoggedIn') || localStorage.getItem('kidsstore_adminLoggedIn') !== 'true') {
      window.location.href = 'login.html';
    }

    function adminLogout() {
      localStorage.removeItem('kidsstore_adminLoggedIn');
      window.location.href = 'login.html';
    }

    // Update sync status
    function updateSyncStatus(status, message) {
      const el = document.getElementById('sync-status');
      if (status === 'syncing') {
        el.className = 'sync-status syncing';
        el.innerHTML = '<div class="loading-spinner" style="width: 14px; height: 14px;"></div> ' + (message || 'Syncing...');
      } else if (status === 'error') {
        el.className = 'sync-status error';
        el.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + (message || 'Connection Error');
      } else {
        el.className = 'sync-status';
        el.innerHTML = '<i class="fas fa-check-circle"></i> ' + (message || 'Connected');
      }
    }

    // Load all dashboard data from MongoDB
    async function loadDashboard() {
      updateSyncStatus('syncing', 'Loading data...');
      
      try {
        // Fetch products from MongoDB
        const productsResponse = await fetch('/api/products');
        const products = productsResponse.ok ? await productsResponse.json() : [];
        
        // Fetch orders from MongoDB
        const ordersResponse = await fetch('/api/orders?admin=true');
        const orders = ordersResponse.ok ? await ordersResponse.json() : [];
        
        // Update stats
        updateStats(products, orders);
        
        // Update recent orders
        updateRecentOrders(orders);
        
        // Update low stock products
        updateLowStock(products);
        
        // Update top products
        updateTopProducts(products);
        
        // Update database status
        updateDatabaseStatus(products.length, orders.length);
        
        // Update last updated time
        document.getElementById('last-updated').textContent = 'Updated: ' + new Date().toLocaleTimeString();
        
        updateSyncStatus('connected', 'MongoDB Connected');
        
        console.log('Dashboard loaded:', products.length, 'products,', orders.length, 'orders');
        
      } catch (error) {
        console.error('Error loading dashboard:', error);
        updateSyncStatus('error', 'Failed to load');
      }
    }

    // Update statistics
    function updateStats(products, orders) {
      // Total Products
      document.getElementById('total-products').textContent = products.length;
      document.getElementById('products-change').textContent = `${products.filter(p => p.availability).length} active`;
      
      // Total Orders
      document.getElementById('total-orders').textContent = orders.length;
      const pendingOrders = orders.filter(o => o.status === 'confirmed' || o.status === 'processing').length;
      document.getElementById('orders-change').textContent = `${pendingOrders} pending`;
      
      // Total Revenue
      const revenue = orders
        .filter(o => o.status !== 'cancelled')
        .reduce((sum, o) => sum + (o.total || 0), 0);
      document.getElementById('total-revenue').textContent = '$' + revenue.toFixed(2);
      
      const thisMonthOrders = orders.filter(o => {
        const orderDate = new Date(o.createdAt);
        const now = new Date();
        return orderDate.getMonth() === now.getMonth() && orderDate.getFullYear() === now.getFullYear();
      });
      const thisMonthRevenue = thisMonthOrders.reduce((sum, o) => sum + (o.total || 0), 0);
      document.getElementById('revenue-change').innerHTML = `<i class="fas fa-arrow-up"></i> $${thisMonthRevenue.toFixed(2)} this month`;
      
      // Low Stock
      const lowStock = products.filter(p => p.stock > 0 && p.stock <= 10);
      const outOfStock = products.filter(p => p.stock === 0);
      document.getElementById('low-stock').textContent = lowStock.length + outOfStock.length;
    }

    // Update recent orders table
    function updateRecentOrders(orders) {
      const tbody = document.getElementById('recent-orders');
      const recentOrders = orders.slice(0, 5);
      
      if (recentOrders.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; color: var(--gray); padding: 2rem;">
              <i class="fas fa-inbox" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
              No orders yet
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = recentOrders.map(order => {
        const statusColors = {
          'confirmed': 'pending',
          'processing': 'pending',
          'shipped': 'active',
          'delivered': 'active',
          'cancelled': 'inactive'
        };
        
        const customerName = order.shippingAddress 
          ? `${order.shippingAddress.firstName || ''} ${order.shippingAddress.lastName || ''}`.trim() 
          : 'Unknown';
        
        return `
          <tr>
            <td><strong>${order.orderId || order._id}</strong></td>
            <td>${customerName}</td>
            <td>$${(order.total || 0).toFixed(2)}</td>
            <td><span class="status-badge status-${statusColors[order.status] || 'pending'}">${order.status || 'Pending'}</span></td>
            <td>${new Date(order.createdAt).toLocaleDateString()}</td>
          </tr>
        `;
      }).join('');
    }

    // Update low stock products
    function updateLowStock(products) {
      const tbody = document.getElementById('low-stock-products');
      const lowStockProducts = products
        .filter(p => p.stock <= 10)
        .sort((a, b) => a.stock - b.stock)
        .slice(0, 5);
      
      if (lowStockProducts.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" style="text-align: center; color: var(--success); padding: 2rem;">
              <i class="fas fa-check-circle" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
              All products are well stocked!
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = lowStockProducts.map(p => {
        const firstImage = p.images && p.images.length > 0 ? p.images[0] : 'https://via.placeholder.com/50';
        
        return `
          <tr>
            <td style="display: flex; align-items: center; gap: 0.5rem;">
              <img src="${firstImage}" class="product-thumb" alt="${p.name}" onerror="this.src='https://via.placeholder.com/50'">
              <span>${p.name.substring(0, 25)}${p.name.length > 25 ? '...' : ''}</span>
            </td>
            <td>${p.category}</td>
            <td><strong style="color: ${p.stock === 0 ? 'var(--danger)' : 'var(--warning)'};">${p.stock}</strong></td>
            <td>
              <span class="status-badge ${p.stock === 0 ? 'status-inactive' : 'status-pending'}">
                ${p.stock === 0 ? 'Out of Stock' : 'Low Stock'}
              </span>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Update top products
    function updateTopProducts(products) {
      const container = document.getElementById('top-products');
      
      // Sort by rating and review count
      const topProducts = products
        .filter(p => p.availability && p.stock > 0)
        .sort((a, b) => (b.rating * b.reviewCount) - (a.rating * a.reviewCount))
        .slice(0, 4);
      
      if (topProducts.length === 0) {
        container.innerHTML = `
          <p style="text-align: center; color: var(--gray); padding: 1rem;">
            No products available
          </p>
        `;
        return;
      }
      
      container.innerHTML = topProducts.map((p, index) => {
        const firstImage = p.images && p.images.length > 0 ? p.images[0] : 'https://via.placeholder.com/40';
        
        return `
          <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; ${index < topProducts.length - 1 ? 'border-bottom: 1px solid var(--light);' : ''}">
            <span style="width: 20px; font-weight: 700; color: var(--primary);">#${index + 1}</span>
            <img src="${firstImage}" style="width: 40px; height: 40px; border-radius: 8px; object-fit: cover;" onerror="this.src='https://via.placeholder.com/40'">
            <div style="flex: 1; min-width: 0;">
              <strong style="display: block; font-size: 0.875rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                ${p.name}
              </strong>
              <small style="color: var(--gray);">
                <i class="fas fa-star" style="color: var(--warning);"></i> ${p.rating || 0} (${p.reviewCount || 0})
              </small>
            </div>
            <strong style="color: var(--primary);">$${p.price.toFixed(2)}</strong>
          </div>
        `;
      }).join('');
    }

    // Update database status
    function updateDatabaseStatus(productsCount, ordersCount) {
      document.getElementById('db-products').textContent = productsCount;
      document.getElementById('db-orders').textContent = ordersCount;
      document.getElementById('db-users').textContent = '-'; // Would need users endpoint
      document.getElementById('db-connection').innerHTML = '<i class="fas fa-check-circle"></i> Connected';
      document.getElementById('db-connection').style.color = 'var(--success)';
    }

    // Refresh dashboard
    async function refreshDashboard() {
      await loadDashboard();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Admin Dashboard - MongoDB Integration');
      loadDashboard();
      
      // Auto-refresh every 30 seconds
      setInterval(() => {
        loadDashboard();
      }, 30000);
    });
  </script>
</body>
</html>
