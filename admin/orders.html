<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Management - KidoCart Admin</title>
  <link rel="stylesheet" href="../css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .order-filters { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .order-filters input, .order-filters select { padding: 0.5rem 1rem; border: 2px solid var(--light); border-radius: 10px; }
    .order-filters input { flex: 1; min-width: 200px; }
    .order-row { cursor: pointer; }
    .order-row:hover { background: var(--pastel-purple); }
    .order-items-preview { display: flex; gap: 0.25rem; }
    .order-items-preview img { width: 35px; height: 35px; border-radius: 5px; object-fit: cover; }
    .order-detail-modal { max-width: 800px; }
    .order-detail-section { margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--light); }
    .order-detail-section:last-child { border-bottom: none; }
    .order-detail-section h4 { margin-bottom: 1rem; color: var(--primary); }
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .detail-item { display: flex; gap: 1rem; padding: 0.75rem; background: var(--light); border-radius: 10px; }
    .detail-item img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
    .status-select { padding: 0.5rem 1rem; border: 2px solid var(--light); border-radius: 10px; font-weight: 600; }
    .status-select.confirmed { border-color: #d97706; color: #d97706; }
    .status-select.processing { border-color: #2563eb; color: #2563eb; }
    .status-select.shipped { border-color: #4f46e5; color: #4f46e5; }
    .status-select.delivered { border-color: #059669; color: #059669; }
    .status-select.cancelled { border-color: #dc2626; color: #dc2626; }
  </style>
</head>
<body>
  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <div class="logo">
        <i class="fas fa-baby"></i> Kido<span>Cart</span>
        <small style="display: block; font-size: 0.7rem; opacity: 0.7;">Admin Panel</small>
      </div>
      <ul class="admin-nav">
        <li><a href="dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a></li>
        <li><a href="products.html"><i class="fas fa-box"></i> Products</a></li>
        <li><a href="orders.html" class="active"><i class="fas fa-shopping-bag"></i> Orders</a></li>
        <li><a href="#" onclick="adminLogout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
      </ul>
      <div style="margin-top: auto; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1);">
        <a href="../index.html" style="color: var(--gray); font-size: 0.875rem;">
          <i class="fas fa-external-link-alt"></i> View Store
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <div class="admin-header">
        <h1>Order Management</h1>
        <div style="display: flex; gap: 1rem;">
          <button class="btn btn-outline" onclick="exportOrders()">
            <i class="fas fa-download"></i> Export
          </button>
        </div>
      </div>

      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Total Orders</h3>
          <p class="value" id="total-orders">0</p>
        </div>
        <div class="stat-card">
          <h3>Pending</h3>
          <p class="value" id="pending-orders" style="color: var(--warning);">0</p>
        </div>
        <div class="stat-card">
          <h3>Processing</h3>
          <p class="value" id="processing-orders" style="color: var(--primary);">0</p>
        </div>
        <div class="stat-card">
          <h3>Delivered</h3>
          <p class="value" id="delivered-orders" style="color: var(--success);">0</p>
        </div>
      </div>

      <!-- Filters -->
      <div class="order-filters">
        <input type="text" id="search-order" placeholder="Search by Order ID or Customer..." oninput="filterOrders()">
        <select id="filter-status" onchange="filterOrders()">
          <option value="">All Status</option>
          <option value="confirmed">Confirmed</option>
          <option value="processing">Processing</option>
          <option value="shipped">Shipped</option>
          <option value="delivered">Delivered</option>
          <option value="cancelled">Cancelled</option>
        </select>
        <input type="date" id="filter-date" onchange="filterOrders()">
      </div>

      <!-- Orders Table -->
      <div class="admin-card">
        <div style="overflow-x: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Items</th>
                <th>Total</th>
                <th>Payment</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="orders-table">
              <tr><td colspan="8" style="text-align: center; color: var(--gray);">No orders found</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- Order Detail Modal -->
  <div class="modal-overlay" id="order-modal">
    <div class="modal order-detail-modal">
      <div class="modal-header">
        <h2 id="modal-order-id">Order Details</h2>
        <button class="modal-close" onclick="closeOrderModal()">&times;</button>
      </div>
      
      <div id="order-detail-content">
        <!-- Order details rendered here -->
      </div>
    </div>
  </div>

  <script src="../js/data.js"></script>
  <script>
    // Check admin auth
    if (!isAdminLoggedIn()) {
      window.location.href = 'login.html';
    }

    function adminLogout() {
      setAdminLoggedIn(false);
      window.location.href = 'login.html';
    }

    function loadStats() {
      const orders = getOrders();
      document.getElementById('total-orders').textContent = orders.length;
      document.getElementById('pending-orders').textContent = orders.filter(o => o.status === 'confirmed').length;
      document.getElementById('processing-orders').textContent = orders.filter(o => o.status === 'processing' || o.status === 'shipped').length;
      document.getElementById('delivered-orders').textContent = orders.filter(o => o.status === 'delivered').length;
    }

    function renderOrdersTable(orders) {
      const tbody = document.getElementById('orders-table');
      const users = getUsers();

      if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--gray);">No orders found</td></tr>';
        return;
      }

      tbody.innerHTML = orders.reverse().map(order => {
        const user = users.find(u => u.id === order.userId);
        const paymentLabels = { card: 'Card', paypal: 'PayPal', applepay: 'Apple Pay', cod: 'COD' };

        return `
          <tr class="order-row" onclick="viewOrder('${order.id}')">
            <td><strong>${order.id}</strong></td>
            <td>
              ${user ? user.name : 'Unknown'}
              <br><small style="color: var(--gray);">${user ? user.email : ''}</small>
            </td>
            <td>
              <div class="order-items-preview">
                ${order.items.slice(0, 3).map(item => `<img src="${item.image}" alt="${item.name}">`).join('')}
                ${order.items.length > 3 ? `<span style="font-size: 0.75rem; color: var(--gray);">+${order.items.length - 3}</span>` : ''}
              </div>
            </td>
            <td><strong>$${order.total.toFixed(2)}</strong></td>
            <td>${paymentLabels[order.paymentMethod] || order.paymentMethod}</td>
            <td>
              <select class="status-select ${order.status}" onchange="updateOrderStatus(event, '${order.id}')" onclick="event.stopPropagation()">
                <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
              </select>
            </td>
            <td>${new Date(order.createdAt).toLocaleDateString()}</td>
            <td>
              <button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); viewOrder('${order.id}')">
                <i class="fas fa-eye"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function filterOrders() {
      const search = document.getElementById('search-order').value.toLowerCase();
      const status = document.getElementById('filter-status').value;
      const date = document.getElementById('filter-date').value;
      const users = getUsers();

      let orders = getOrders();

      if (search) {
        orders = orders.filter(o => {
          const user = users.find(u => u.id === o.userId);
          return o.id.toLowerCase().includes(search) || 
                 (user && user.name.toLowerCase().includes(search)) ||
                 (user && user.email.toLowerCase().includes(search));
        });
      }

      if (status) {
        orders = orders.filter(o => o.status === status);
      }

      if (date) {
        orders = orders.filter(o => o.createdAt.startsWith(date));
      }

      renderOrdersTable(orders);
    }

    function updateOrderStatus(event, orderId) {
      const newStatus = event.target.value;
      const orders = getOrders();
      const orderIndex = orders.findIndex(o => o.id === orderId);

      if (orderIndex > -1) {
        orders[orderIndex].status = newStatus;
        saveOrders(orders);
        event.target.className = `status-select ${newStatus}`;
        loadStats();
      }
    }

    function viewOrder(orderId) {
      const orders = getOrders();
      const order = orders.find(o => o.id === orderId);
      const users = getUsers();
      const user = users.find(u => u.id === order.userId);

      if (!order) return;

      document.getElementById('modal-order-id').textContent = order.id;
      
      const paymentLabels = { card: 'Credit/Debit Card', paypal: 'PayPal', applepay: 'Apple Pay', cod: 'Cash on Delivery' };

      document.getElementById('order-detail-content').innerHTML = `
        <div class="order-detail-section">
          <div class="detail-grid">
            <div>
              <p><strong>Customer:</strong> ${user ? user.name : 'Unknown'}</p>
              <p><strong>Email:</strong> ${user ? user.email : '-'}</p>
              <p><strong>Phone:</strong> ${order.shippingAddress.phone}</p>
            </div>
            <div>
              <p><strong>Order Date:</strong> ${new Date(order.createdAt).toLocaleString()}</p>
              <p><strong>Payment:</strong> ${paymentLabels[order.paymentMethod]}</p>
              <p><strong>Status:</strong> <span class="status-badge status-${order.status === 'delivered' ? 'active' : order.status === 'cancelled' ? 'inactive' : 'pending'}">${order.status.toUpperCase()}</span></p>
            </div>
          </div>
        </div>

        <div class="order-detail-section">
          <h4><i class="fas fa-map-marker-alt"></i> Shipping Address</h4>
          <p>
            ${order.shippingAddress.firstName} ${order.shippingAddress.lastName}<br>
            ${order.shippingAddress.address}${order.shippingAddress.address2 ? ', ' + order.shippingAddress.address2 : ''}<br>
            ${order.shippingAddress.city}, ${order.shippingAddress.state} ${order.shippingAddress.zip}<br>
            ${order.shippingAddress.country}
          </p>
        </div>

        <div class="order-detail-section">
          <h4><i class="fas fa-box"></i> Order Items (${order.items.length})</h4>
          ${order.items.map(item => `
            <div class="detail-item">
              <img src="${item.image}" alt="${item.name}">
              <div style="flex: 1;">
                <strong>${item.name}</strong>
                <p style="color: var(--gray); font-size: 0.875rem;">
                  Qty: ${item.quantity}
                  ${item.size ? ' | Size: ' + item.size : ''}
                  ${item.color ? ' | Color: ' + item.color : ''}
                </p>
              </div>
              <div style="text-align: right;">
                <p>$${item.price.toFixed(2)} Ã— ${item.quantity}</p>
                <strong style="color: var(--primary);">$${(item.price * item.quantity).toFixed(2)}</strong>
              </div>
            </div>
          `).join('')}
        </div>

        <div class="order-detail-section" style="border-bottom: none;">
          <h4><i class="fas fa-calculator"></i> Order Summary</h4>
          <div style="max-width: 300px; margin-left: auto;">
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
              <span>Subtotal</span><span>$${order.subtotal.toFixed(2)}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
              <span>Shipping</span><span>${order.shipping === 0 ? 'FREE' : '$' + order.shipping.toFixed(2)}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
              <span>Tax</span><span>$${order.tax.toFixed(2)}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 1rem 0; border-top: 2px solid var(--primary); margin-top: 0.5rem; font-size: 1.25rem; font-weight: 700; color: var(--primary);">
              <span>Total</span><span>$${order.total.toFixed(2)}</span>
            </div>
          </div>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
          <button class="btn btn-outline" onclick="closeOrderModal()">Close</button>
          <button class="btn btn-primary" onclick="window.print()">
            <i class="fas fa-print"></i> Print Invoice
          </button>
        </div>
      `;

      document.getElementById('order-modal').classList.add('active');
    }

    function closeOrderModal() {
      document.getElementById('order-modal').classList.remove('active');
    }

    function exportOrders() {
      const orders = getOrders();
      const users = getUsers();
      
      let csv = 'Order ID,Customer,Email,Total,Status,Payment,Date\n';
      orders.forEach(order => {
        const user = users.find(u => u.id === order.userId);
        csv += `${order.id},${user ? user.name : 'Unknown'},${user ? user.email : '-'},$${order.total.toFixed(2)},${order.status},${order.paymentMethod},${order.createdAt}\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'orders_export.csv';
      a.click();
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadStats();
      filterOrders();
    });
  </script>
</body>
</html>
