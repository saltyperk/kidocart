<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Account - KidoCart</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Account CSS -->
  <link rel="stylesheet" href="css/account.css">
</head>
<body>
  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <h1>My Account</h1>
      <p>Manage your profile, orders, and addresses</p>
    </div>

    <!-- Account Layout -->
    <div class="account-layout">
      <!-- Sidebar -->
      <aside class="account-sidebar">
        <div class="user-info">
          <div class="user-avatar" id="user-avatar">U</div>
          <div class="user-name" id="user-name">User Name</div>
          <div class="user-email" id="user-email">user@example.com</div>
        </div>

        <nav>
          <ul class="account-nav">
            <li>
              <a href="#" class="active" data-section="profile">
                <i class="fas fa-user"></i>
                <span>Profile</span>
              </a>
            </li>
            <li>
              <a href="#" data-section="orders">
                <i class="fas fa-shopping-bag"></i>
                <span>My Orders</span>
              </a>
            </li>
            <li>
              <a href="#" data-section="addresses">
                <i class="fas fa-map-marker-alt"></i>
                <span>Addresses</span>
              </a>
            </li>
            <li>
              <a href="#" data-section="wishlist">
                <i class="fas fa-heart"></i>
                <span>Wishlist</span>
              </a>
            </li>
            <li>
              <a href="#" data-section="settings">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
              </a>
            </li>
          </ul>
        </nav>

        <button class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i>
          Logout
        </button>
      </aside>

      <!-- Main Content -->
      <main class="account-content">
        <!-- Profile Section -->
        <section id="profile" class="section active">
          <h2 class="section-title">
            <i class="fas fa-user-circle"></i>
            Profile Information
          </h2>
          
          <form class="profile-form" id="profile-form" onsubmit="updateProfile(event)">
            <div class="form-group">
              <label for="profile-name">Full Name</label>
              <input type="text" id="profile-name" class="form-input" required>
            </div>

            <div class="form-group">
              <label for="profile-email">Email Address</label>
              <input type="email" id="profile-email" class="form-input" disabled>
            </div>

            <div class="form-group">
              <label for="profile-phone">Phone Number</label>
              <input type="tel" id="profile-phone" class="form-input">
            </div>

            <div style="display: flex; gap: 1rem;">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i>
                Save Changes
              </button>
              <button type="button" class="btn btn-secondary" onclick="cancelEdit()">
                Cancel
              </button>
            </div>
          </form>
        </section>

        <!-- Orders Section -->
        <section id="orders" class="section">
          <h2 class="section-title">
            <i class="fas fa-shopping-bag"></i>
            My Orders
          </h2>
          
          <div class="orders-list" id="orders-list">
            <!-- Orders will be loaded here -->
            <div class="empty-state">
              <i class="fas fa-shopping-bag"></i>
              <h3>No orders yet</h3>
              <p>Start shopping to see your orders here</p>
              <a href="products.html" class="btn btn-primary" style="margin-top: 1rem;">
                Browse Products
              </a>
            </div>
          </div>
        </section>

        <!-- Addresses Section -->
        <section id="addresses" class="section">
          <h2 class="section-title">
            <i class="fas fa-map-marker-alt"></i>
            Saved Addresses
          </h2>
          
          <div class="address-grid" id="addresses-list">
            <!-- Addresses will be loaded here -->
            <div class="empty-state">
              <i class="fas fa-map-marker-alt"></i>
              <h3>No addresses saved</h3>
              <p>Add an address for faster checkout</p>
              <button class="btn btn-primary" style="margin-top: 1rem;" onclick="addAddress()">
                <i class="fas fa-plus"></i>
                Add Address
              </button>
            </div>
          </div>
        </section>

        <!-- Wishlist Section -->
        <section id="wishlist" class="section">
          <h2 class="section-title">
            <i class="fas fa-heart"></i>
            My Wishlist
          </h2>
          
          <div id="wishlist-grid">
            <!-- Wishlist items will be loaded here -->
            <div class="empty-state">
              <i class="fas fa-heart"></i>
              <h3>Your wishlist is empty</h3>
              <p>Save items you love for later</p>
              <a href="products.html" class="btn btn-primary" style="margin-top: 1rem;">
                Browse Products
              </a>
            </div>
          </div>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="section">
          <h2 class="section-title">
            <i class="fas fa-cog"></i>
            Account Settings
          </h2>
          
          <div class="profile-form">
            <h3 style="margin-bottom: 1rem;">Change Password</h3>
            
            <form id="password-form" onsubmit="changePassword(event)">
              <div class="form-group">
                <label for="current-password">Current Password</label>
                <input type="password" id="current-password" class="form-input" required>
              </div>

              <div class="form-group">
                <label for="new-password">New Password</label>
                <input type="password" id="new-password" class="form-input" required>
              </div>

              <div class="form-group">
                <label for="confirm-password">Confirm New Password</label>
                <input type="password" id="confirm-password" class="form-input" required>
              </div>

              <button type="submit" class="btn btn-primary">
                <i class="fas fa-key"></i>
                Update Password
              </button>
            </form>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    // Global variables
    let currentUser = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', async function() {
      await loadUserData();
      setupNavigation();
    });

    // Load user data
    async function loadUserData() {
      const token = localStorage.getItem('kidocart_token');
      
      if (!token) {
        window.location.href = 'login.html';
        return;
      }

      try {
        // Decode token to get user info
        const payload = JSON.parse(atob(token.split('.')[1]));
        currentUser = payload;

        // Update UI
        document.getElementById('user-name').textContent = currentUser.name || 'User';
        document.getElementById('user-email').textContent = currentUser.email || '';
        document.getElementById('user-avatar').textContent = (currentUser.name || 'U').charAt(0).toUpperCase();

        // Fill profile form
        document.getElementById('profile-name').value = currentUser.name || '';
        document.getElementById('profile-email').value = currentUser.email || '';
        document.getElementById('profile-phone').value = currentUser.phone || '';

        // Load orders
        await loadOrders();
      } catch (error) {
        console.error('Error loading user data:', error);
        localStorage.removeItem('kidocart_token');
        window.location.href = 'login.html';
      }
    }

    // Setup navigation
    function setupNavigation() {
      const navLinks = document.querySelectorAll('.account-nav a');
      
      navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          
          // Remove active class from all links
          navLinks.forEach(l => l.classList.remove('active'));
          
          // Add active class to clicked link
          this.classList.add('active');
          
          // Hide all sections
          document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
          
          // Show selected section
          const sectionId = this.getAttribute('data-section');
          document.getElementById(sectionId).classList.add('active');
        });
      });
    }

    // Load orders
    async function loadOrders() {
      const token = localStorage.getItem('kidocart_token');
      
      try {
        const response = await fetch('/api/orders', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        
        if (response.ok) {
          const orders = await response.json();
          displayOrders(orders);
        }
      } catch (error) {
        console.error('Error loading orders:', error);
      }
    }

    // Display orders
    function displayOrders(orders) {
      const container = document.getElementById('orders-list');
      
      if (!orders || orders.length === 0) {
        return; // Keep empty state
      }

      container.innerHTML = orders.map(order => `
        <div class="order-card">
          <div class="order-header">
            <div>
              <div class="order-id">Order #${order._id.slice(-8).toUpperCase()}</div>
              <div class="order-date">${new Date(order.createdAt).toLocaleDateString()}</div>
            </div>
            <span class="order-status status-${order.status}">${order.status}</span>
          </div>
          
          <div class="order-items">
            ${order.items.map(item => `
              <div class="order-item">
                <img src="${item.product?.images?.[0] || 'placeholder.jpg'}" alt="${item.product?.name}" class="order-item-image">
                <div class="order-item-info">
                  <div class="order-item-name">${item.product?.name}</div>
                  <div class="order-item-details">Qty: ${item.quantity} × ₹${item.price}</div>
                </div>
              </div>
            `).join('')}
          </div>
          
          <div class="order-footer">
            <div class="order-total">Total: ₹${order.total.toLocaleString('en-IN')}</div>
            <button class="btn btn-sm btn-primary" onclick="viewOrder('${order._id}')">
              View Details
            </button>
          </div>
        </div>
      `).join('');
    }

    // Update profile
    async function updateProfile(e) {
      e.preventDefault();
      
      const token = localStorage.getItem('kidocart_token');
      const name = document.getElementById('profile-name').value;
      const phone = document.getElementById('profile-phone').value;

      try {
        const response = await fetch('/api/users/profile', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ name, phone })
        });

        if (response.ok) {
          alert('Profile updated successfully!');
          await loadUserData();
        } else {
          alert('Failed to update profile');
        }
      } catch (error) {
        console.error('Error updating profile:', error);
        alert('Error updating profile');
      }
    }

    // Change password
    async function changePassword(e) {
      e.preventDefault();
      
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;

      if (newPassword !== confirmPassword) {
        alert('New passwords do not match!');
        return;
      }

      const token = localStorage.getItem('kidocart_token');

      try {
        const response = await fetch('/api/users/change-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ currentPassword, newPassword })
        });

        if (response.ok) {
          alert('Password changed successfully!');
          document.getElementById('password-form').reset();
        } else {
          const error = await response.json();
          alert(error.error || 'Failed to change password');
        }
      } catch (error) {
        console.error('Error changing password:', error);
        alert('Error changing password');
      }
    }

    // Logout
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('kidocart_token');
        window.location.href = 'login.html';
      }
    }

    // Placeholder functions
    function cancelEdit() {
      loadUserData();
    }

    function addAddress() {
      alert('Add address feature coming soon!');
    }

    function viewOrder(orderId) {
      alert('Order details: ' + orderId);
    }
  </script>
</body>
</html>
